<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthub Connect</title>
    <link rel="stylesheet" href="index_styles.css">
    <style>
        /* Chat Bubble Styles */
        .chat-bubble-trigger {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .chat-bubble-trigger:hover {
            transform: scale(1.1);
        }

        .chat-bubble-trigger svg {
            width: 30px;
            height: 30px;
            fill: white;
        }

        .chat-bubble-trigger.open {
            display: none;
        }

        .chat-window {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 380px;
            height: 550px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            z-index: 1001;
            overflow: hidden;
        }

        .chat-window.open {
            display: flex;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .chat-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .chat-body {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: #f7f7fb;
        }

        .chat-footer {
            display: flex;
            gap: 8px;
            padding: 12px;
            border-top: 1px solid #e5e5e5;
            background: white;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .chat-send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: opacity 0.2s;
        }

        .chat-send-btn:hover {
            opacity: 0.9;
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .msg {
            display: flex;
            margin: 10px 0;
            max-width: 85%;
        }

        .msg.user {
            margin-left: auto;
            justify-content: flex-end;
        }

        .msg.ai {
            margin-right: auto;
            justify-content: flex-start;
        }

        .bubble {
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .bubble.user {
            background: #f2f2f7;
            color: #333;
        }

        .bubble.ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        @media (max-width: 768px) {
            .chat-window {
                width: calc(100% - 40px);
                height: calc(100% - 40px);
                bottom: 20px;
                right: 20px;
            }
            
            .chat-bubble-trigger {
                bottom: 20px;
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="Title">
        <img src="healthhub-logo.svg" alt="HealthHub Connect Logo" style="width:300px;">
        <h1>Welcome to Healthub Connect!</h1>
        <div id="userInfo" style="margin:0; text-align: center;"></div>
    </div>
    
    <div class="top-bar">
        <button class="signin-btn" onclick="location.href='signin.html'">Sign In</button>
    </div>
    
    <hr>
    
    <h2 class="Navigations">
        <a href="documents.html">Documents</a>
        <a href="tracker.html">Trackers</a>
        <a href="appointments.html">Appointments</a>
        <a href="insurance.html">Insurance Hub</a>
        <a href="summaries.html">Visit Summaries</a>
        <a href="family.html">Family Access</a>
        <a href="payments.html">Payments</a>
        <a href="support.html">Support Call Center</a>
        <a href="links.html">Helpful Links</a>
        <a href="about.html">About</a>
    </h2>
    
    <hr>
    
    <section>
        <h2>About Healthub Connect</h2>
        <p>
            Healthub Connect is a modern health platform that helps users manage
            their personal and medical data efficiently. From tracking your daily
            vitals to managing appointments, our mission is to keep you connected to
            your health.
        </p>
    </section>
    
    <section>
        <h2>Core Features</h2>
        <ul>
            <li>Upload and access health documents anytime</li>
            <li>Track your heart rate and blood sugar daily</li>
            <li>Set reminders for medication and appointments</li>
            <li>Communicate directly with a medical AI chatbot</li>
            <li>Securely manage insurance and payment details</li>
            <li>And more</li>  
        </ul>
    </section>
    <div style="text-align:center;">
        <img src="health_placeholder.jpeg" alt="Healthub Connect" style="width:100%;max-width:600px;">
    </div>
    <div id="registerSection" style="text-align: center; margin: 20px 0;">
        <a href="register-simple.html" class="signin-btn" style="display: inline-block; text-decoration: none;">Get Started - Register Now</a>
    </div>

    <!-- Chat Bubble (only shown when logged in) -->
    <div id="chatBubbleTrigger" class="chat-bubble-trigger" style="display: none;" onclick="openChat()">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
            <path d="M7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/>
        </svg>
    </div>

    <!-- Chat Window -->
    <div id="chatWindow" class="chat-window">
        <div class="chat-header">
            <h3>AI Health Assistant</h3>
            <button class="chat-close" onclick="closeChat()">×</button>
        </div>
        <div id="chatBody" class="chat-body"></div>
        <div class="chat-footer">
            <input id="chatInput" class="chat-input" placeholder="Ask a health question..." onkeypress="if(event.key==='Enter') handleSend()">
            <button id="chatSendBtn" class="chat-send-btn" onclick="handleSend()">Send</button>
        </div>
    </div>

    <!-- Load Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://hbtgwzneuhdqlmriwvje.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhidGd3em5ldWhkcWxtcml3dmplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNDI5MTQsImV4cCI6MjA3NTkxODkxNH0.1v1OLYSEPRBKaZWQu1sJo8DoRzYePfdc7Zcs8i8TF78';
        
        const AI_FUNCTION_URL = 'https://hbtgwzneuhdqlmriwvje.supabase.co/functions/v1/ai-chat-index-ts';
        
        let supabase;
        let convo = [];
        let isLoggedIn = false;

        // Wait for everything to load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Supabase
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            console.log('Supabase initialized');
            
            // Check auth state
            checkAuthState();
            
            // Initialize chat conversation
            initializeChat();
        });

        async function checkAuthState() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                const authButton = document.querySelector('.signin-btn');
                const userInfo = document.getElementById('userInfo');
                const chatBubble = document.getElementById('chatBubbleTrigger');
                const registerSection = document.getElementById('registerSection');
                
                console.log('Auth check:', session);

                if (session && session.user) {
                    // User is signed in
                    isLoggedIn = true;
                    const firstName = session.user.user_metadata?.first_name || session.user.email;
                    userInfo.innerHTML = `Hello, ${firstName} — <a href="#" onclick="signOut(); return false;">Sign Out</a>`;
                    authButton.textContent = 'Sign Out';
                    authButton.onclick = signOut;
                    
                    // Show chat bubble and hide register section
                    chatBubble.style.display = 'flex';
                    if (registerSection) registerSection.style.display = 'none';
                } else {
                    // User is signed out
                    isLoggedIn = false;
                    userInfo.innerHTML = '';
                    authButton.textContent = 'Sign In';
                    authButton.onclick = function() {
                        window.location.href = 'signin.html';
                    };
                    
                    // Hide chat bubble and show register section
                    chatBubble.style.display = 'none';
                    if (registerSection) registerSection.style.display = 'block';
                    closeChat();
                }
            } catch (error) {
                console.error('Auth check error:', error);
            }
        }

        function initializeChat() {
            // Initialize conversation with system message
            convo = [{
                role: "system",
                content: "You are a professional medical assistant. Keep answers short, factual, direct, and medically accurate. You only answer medical-related questions. If a question is not medical, respond with: 'Sorry, I can only answer medical-related questions.' If a request is unsafe (self-harm, drugs, medical prescriptions, or illegal topics), respond with: 'I can't help with that. Please contact a licensed medical professional or emergency services if needed.' Never break character. Do not provide emotional therapy."
            }];
        }

        function openChat() {
            if (!isLoggedIn) return;
            
            const chatWindow = document.getElementById('chatWindow');
            const chatBubble = document.getElementById('chatBubbleTrigger');
            
            chatWindow.classList.add('open');
            chatBubble.classList.add('open');
            
            // Show greeting if no messages yet
            const chatBody = document.getElementById('chatBody');
            if (chatBody.children.length === 0) {
                addMessage('ai', "Hello. I am the AI Health Assistant. I can help answer health questions and provide medical information. How may I assist you?");
            }
            
            // Focus input
            document.getElementById('chatInput').focus();
        }

        function closeChat() {
            const chatWindow = document.getElementById('chatWindow');
            const chatBubble = document.getElementById('chatBubbleTrigger');
            
            chatWindow.classList.remove('open');
            chatBubble.classList.remove('open');
        }

        function addMessage(role, text) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerHTML = `<div class="bubble ${role}">${text}</div>`;
            const chatBody = document.getElementById('chatBody');
            chatBody.appendChild(div);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        async function handleSend() {
            if (!isLoggedIn) {
                alert('Please sign in to use the AI assistant');
                return;
            }
            
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            // Add user message
            addMessage('user', text);
            convo.push({ role: 'user', content: text });
            input.value = '';

            // Disable send button
            const sendBtn = document.getElementById('chatSendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Thinking...';

            // Call AI
            await callAI();
            
            // Re-enable send button
            sendBtn.disabled = false;
            sendBtn.textContent = 'Send';
        }

        async function callAI() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                addMessage('ai', "You are signed out. Please sign in again.");
                return;
            }

            const messages = [...convo];

            try {
                const res = await fetch(AI_FUNCTION_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({ messages })
                });

                const json = await res.json();
                const reply = json.reply || "No response.";
                addMessage('ai', reply);
                convo.push({ role: 'assistant', content: reply });

            } catch (err) {
                console.error(err);
                addMessage('ai', "I had an issue processing your request. Try again.");
            }
        }

        async function signOut() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                console.log('Signed out successfully');
                // Refresh the page to update UI
                window.location.reload();
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        // Listen for auth state changes
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event);
            checkAuthState();
        });
    </script>
</body>
</html>



