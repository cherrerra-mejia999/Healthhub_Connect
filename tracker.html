<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Tracker - Healthub Connect</title>
    <link rel="stylesheet" href="index_styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        section {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .page-header h2 {
            margin: 0 0 10px 0;
            color: #4b3fa6;
        }
        
        .page-header p {
            margin: 0;
            color: #666;
        }
        
        /* Layout Grid */
        .tracker-layout {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 25px;
            margin: 25px 0;
        }
        
        @media (max-width: 1024px) {
            .tracker-layout {
                grid-template-columns: 1fr;
            }
        }
        
        /* Cards */
        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: box-shadow 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .card-header h3 {
            margin: 0;
            color: #4b3fa6;
            font-size: 18px;
            font-weight: 600;
        }
        
        /* Input Form Sidebar */
        .sidebar {
            position: sticky;
            top: 20px;
            align-self: start;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #4b3fa6;
            box-shadow: 0 0 0 3px rgba(75, 63, 166, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            font-size: 15px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-primary:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Main Content Area */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        /* Today's Entry Banner */
        .current-entry {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border: 2px solid #4b3fa6;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 10px;
        }
        
        .current-entry h4 {
            margin: 0 0 12px 0;
            color: #4b3fa6;
            font-size: 16px;
        }
        
        .metrics-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 14px;
            color: #333;
        }
        
        .metric-item {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            white-space: nowrap;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin: 8px 0;
        }
        
        .stat-label {
            font-size: 13px;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Graphs Grid */
        .graphs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 20px;
        }
        
        .graph-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .graph-card h4 {
            margin: 0 0 15px 0;
            color: #4b3fa6;
            font-size: 15px;
            font-weight: 600;
        }
        
        .chart-container {
            position: relative;
            height: 220px;
        }
        
        .circular-chart-container {
            position: relative;
            height: 220px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .calorie-goal-input {
            margin-top: 12px;
            text-align: center;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }
        
        .calorie-goal-input label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            display: block;
            margin-bottom: 8px;
        }
        
        .calorie-goal-input input {
            width: 90px;
            padding: 6px 10px;
            text-align: center;
            border: 2px solid #e5e5e5;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .calorie-goal-input button {
            padding: 6px 12px;
            background: #4b3fa6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 8px;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .calorie-goal-input button:hover {
            background: #3a2f88;
        }
        
        /* Export Section */
        .export-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .export-header {
            margin-bottom: 20px;
        }
        
        .export-header h3 {
            margin: 0 0 8px 0;
            color: #4b3fa6;
            font-size: 18px;
        }
        
        .export-header p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        
        .export-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }
        
        .export-btn {
            padding: 12px 20px;
            border: 2px solid #4b3fa6;
            background: white;
            color: #4b3fa6;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .export-btn:hover {
            background: #4b3fa6;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(75, 63, 166, 0.3);
        }
        
        .export-btn:active {
            transform: translateY(0);
        }
        
        .export-btn span {
            display: block;
            font-size: 11px;
            font-weight: normal;
            margin-top: 4px;
            opacity: 0.8;
        }
        
        /* Messages */
        .message {
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .message.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .login-prompt {
            text-align: center;
            padding: 60px 20px;
        }
        
        .login-prompt h3 {
            color: #4b3fa6;
            margin-bottom: 15px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .graphs-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .export-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="Title">
        <h1>Health Tracker</h1>
        <div id="userInfo" style="margin:0; text-align: center;"></div>
    </div>
    
    <div class="top-bar">
        <button class="signin-btn" id="authButton" onclick="handleAuth()">Sign In</button>
    </div>
    
    <hr>
    
    <h2 class="Navigations">
        <a href="index.html">Home</a>
        <a href="documents.html">Documents</a>
        <a href="tracker.html">Trackers</a>
        <a href="appointments.html">Appointments</a>
        <a href="insurance.html">Insurance Hub</a>
        <a href="summaries.html">Visit Summaries</a>
        <a href="family.html">Family Access</a>
        <a href="payments.html">Payments</a>
        <a href="support.html">Support Call Center</a>
        <a href="links.html">Helpful Links</a>
        <a href="about.html">About</a>
    </h2>
    
    <hr>
    
    <section>
        <div id="content"></div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        const supabaseUrl = 'https://hbtgwzneuhdqlmriwvje.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhidGd3em5ldWhkcWxtcml3dmplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNDI5MTQsImV4cCI6MjA3NTkxODkxNH0.1v1OLYSEPRBKaZWQu1sJo8DoRzYePfdc7Zcs8i8TF78';
        
        let supabase;
        let currentUserId;
        let calorieGoal = 2000;
        let stepsChart, heartRateChart, caloriesChart, bloodPressureChart, sleepChart;
        let allUserData = [];

        document.addEventListener('DOMContentLoaded', function() {
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            const savedGoal = localStorage.getItem('calorieGoal');
            if (savedGoal) calorieGoal = parseInt(savedGoal);
            checkAuth();
        });

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            const authButton = document.getElementById('authButton');
            const userInfo = document.getElementById('userInfo');
            const content = document.getElementById('content');

            if (session) {
                currentUserId = session.user.id;
                
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('first_name, last_name')
                    .eq('user_id', currentUserId)
                    .single();

                const firstName = profile?.first_name || session.user.email;
                userInfo.innerHTML = `Hello, ${firstName} — <a href="#" onclick="signOut(); return false;">Sign Out</a>`;
                authButton.style.display = 'none';
                
                loadTrackerUI();
            } else {
                userInfo.innerHTML = '';
                authButton.style.display = 'block';
                authButton.textContent = 'Sign In';
                
                content.innerHTML = `
                    <div class="login-prompt">
                        <h3>Please Sign In to Track Your Health</h3>
                        <p>You need to be logged in to track your daily health metrics.</p>
                        <button onclick="handleAuth()" class="signin-btn">Sign In</button>
                    </div>
                `;
            }
        }

        function loadTrackerUI() {
            document.getElementById('content').innerHTML = `
                <div class="page-header">
                    <h2>Daily Health Tracker</h2>
                    <p>Monitor your vitals and track your wellness journey</p>
                </div>
                
                <div id="messageArea"></div>
                <div id="todayEntry"></div>
                
                <div class="tracker-layout">
                    <div class="sidebar">
                        <div class="card">
                            <div class="card-header">
                                <h3>Log Today's Metrics</h3>
                            </div>
                            <form id="trackerForm">
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" id="entry_date" required>
                                </div>
                                
                                <div class="form-group">
                                    <label>Heart Rate (bpm)</label>
                                    <input type="number" id="heart_rate" placeholder="e.g., 72" min="30" max="200">
                                </div>
                                
                                <div class="form-group">
                                    <label>Blood Pressure</label>
                                    <input type="text" id="blood_pressure" placeholder="e.g., 120/80" pattern="[0-9]{2,3}/[0-9]{2,3}">
                                </div>
                                
                                <div class="form-group">
                                    <label>Sleep Hours</label>
                                    <input type="number" id="sleep_cycles_hours" placeholder="e.g., 7.5" step="0.5" min="0" max="24">
                                </div>
                                
                                <div class="form-group">
                                    <label>Steps</label>
                                    <input type="number" id="steps" placeholder="e.g., 8000" min="0">
                                </div>
                                
                                <div class="form-group">
                                    <label>Calories Burned</label>
                                    <input type="number" id="calories_burned" placeholder="e.g., 2000" min="0">
                                </div>
                                
                                <button type="submit" class="btn-primary" id="submitBtn">Save Entry</button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="main-content">
                        <div id="statsArea"></div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3>Visual Analytics</h3>
                            </div>
                            <div class="graphs-grid">
                                <div class="graph-card">
                                    <h4>Steps (Last 7 Days)</h4>
                                    <div class="chart-container">
                                        <canvas id="stepsChart"></canvas>
                                    </div>
                                </div>
                                
                                <div class="graph-card">
                                    <h4>Heart Rate Trend</h4>
                                    <div class="chart-container">
                                        <canvas id="heartRateChart"></canvas>
                                    </div>
                                </div>
                                
                                <div class="graph-card">
                                    <h4>Calories Progress</h4>
                                    <div class="circular-chart-container">
                                        <canvas id="caloriesChart"></canvas>
                                    </div>
                                    <div class="calorie-goal-input">
                                        <label>Daily Goal</label>
                                        <input type="number" id="calorieGoalInput" value="${calorieGoal}" min="100" step="50">
                                        <button onclick="updateCalorieGoal()">Update</button>
                                    </div>
                                </div>
                                
                                <div class="graph-card">
                                    <h4>Blood Pressure (Systolic)</h4>
                                    <div class="chart-container">
                                        <canvas id="bloodPressureChart"></canvas>
                                    </div>
                                </div>
                                
                                <div class="graph-card">
                                    <h4>Sleep Duration</h4>
                                    <div class="chart-container">
                                        <canvas id="sleepChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="export-section">
                            <div class="export-header">
                                <h3>Export Health Reports</h3>
                                <p>Download comprehensive health summaries as PDF</p>
                            </div>
                            <div class="export-buttons">
                                <button class="export-btn" onclick="exportPDF('weekly')">
                                    Weekly Report
                                    <span>Last 7 days</span>
                                </button>
                                <button class="export-btn" onclick="exportPDF('monthly')">
                                    Monthly Report
                                    <span>Last 30 days</span>
                                </button>
                                <button class="export-btn" onclick="exportPDF('yearly')">
                                    Yearly Report
                                    <span>Last 365 days</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('entry_date').value = new Date().toISOString().split('T')[0];
            document.getElementById('trackerForm').addEventListener('submit', handleSubmit);
            
            loadAllData();
            loadTodayEntry();
            loadStats();
            loadGraphData();
        }

        async function loadAllData() {
            try {
                const { data, error } = await supabase
                    .from('daily_tracker')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .order('date', { ascending: false });

                if (error) throw error;
                allUserData = data || [];
            } catch (error) {
                console.error('Error loading all data:', error);
            }
        }

        async function loadTodayEntry() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const { data, error } = await supabase
                    .from('daily_tracker')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .eq('date', today)
                    .single();

                const todayEntry = document.getElementById('todayEntry');
                
                if (data && !error) {
                    todayEntry.innerHTML = `
                        <div class="current-entry">
                            <h4>Today's Entry (${new Date(data.date).toLocaleDateString()})</h4>
                            <div class="metrics-row">
                                ${data.heart_rate ? `<span class="metric-item">Heart Rate: <strong>${data.heart_rate} bpm</strong></span>` : ''}
                                ${data.blood_pressure ? `<span class="metric-item">BP: <strong>${data.blood_pressure}</strong></span>` : ''}
                                ${data.sleep_cycles_hours ? `<span class="metric-item">Sleep: <strong>${data.sleep_cycles_hours} hrs</strong></span>` : ''}
                                ${data.steps ? `<span class="metric-item">Steps: <strong>${data.steps.toLocaleString()}</strong></span>` : ''}
                                ${data.calories_burned ? `<span class="metric-item">Calories: <strong>${data.calories_burned}</strong></span>` : ''}
                            </div>
                        </div>
                    `;
                    
                    if (data.heart_rate) document.getElementById('heart_rate').value = data.heart_rate;
                    if (data.blood_pressure) document.getElementById('blood_pressure').value = data.blood_pressure;
                    if (data.sleep_cycles_hours) document.getElementById('sleep_cycles_hours').value = data.sleep_cycles_hours;
                    if (data.steps) document.getElementById('steps').value = data.steps;
                    if (data.calories_burned) document.getElementById('calories_burned').value = data.calories_burned;
                }
            } catch (error) {
                console.log('No entry for today yet');
            }
        }

        async function loadStats() {
            try {
                const { data, error } = await supabase
                    .from('daily_tracker')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .order('date', { ascending: false })
                    .limit(30);

                if (error) throw error;

                const statsArea = document.getElementById('statsArea');
                
                if (data && data.length > 0) {
                    const avgHeartRate = Math.round(data.filter(d => d.heart_rate).reduce((sum, d) => sum + d.heart_rate, 0) / data.filter(d => d.heart_rate).length) || 0;
                    const avgSleep = (data.filter(d => d.sleep_cycles_hours).reduce((sum, d) => sum + parseFloat(d.sleep_cycles_hours), 0) / data.filter(d => d.sleep_cycles_hours).length).toFixed(1) || 0;
                    const avgSteps = Math.round(data.filter(d => d.steps).reduce((sum, d) => sum + d.steps, 0) / data.filter(d => d.steps).length) || 0;
                    const avgCalories = Math.round(data.filter(d => d.calories_burned).reduce((sum, d) => sum + d.calories_burned, 0) / data.filter(d => d.calories_burned).length) || 0;
                    
                    statsArea.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Avg Heart Rate</div>
                                <div class="stat-value">${avgHeartRate}</div>
                                <div class="stat-label">BPM (30 Days)</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <div class="stat-label">Avg Sleep</div>
                                <div class="stat-value">${avgSleep}</div>
                                <div class="stat-label">Hours (30 Days)</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                <div class="stat-label">Avg Steps</div>
                                <div class="stat-value">${avgSteps.toLocaleString()}</div>
                                <div class="stat-label">Steps (30 Days)</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                                <div class="stat-label">Avg Calories</div>
                                <div class="stat-value">${avgCalories}</div>
                                <div class="stat-label">KCAL (30 Days)</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadGraphData() {
            try {
                const { data, error } = await supabase
                    .from('daily_tracker')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .order('date', { ascending: true })
                    .limit(7);

                if (error) throw error;
                if (!data || data.length === 0) return;

                const dates = data.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                const steps = data.map(d => d.steps || 0);
                const heartRates = data.map(d => d.heart_rate || null);
                const sleepHours = data.map(d => d.sleep_cycles_hours || null);
                const bloodPressureSystolic = data.map(d => {
                    if (d.blood_pressure) {
                        const match = d.blood_pressure.match(/^(\d+)/);
                        return match ? parseInt(match[1]) : null;
                    }
                    return null;
                });

                createStepsChart(dates, steps);
                createHeartRateChart(dates, heartRates);
                createCaloriesChart();
                createBloodPressureChart(dates, bloodPressureSystolic);
                createSleepChart(dates, sleepHours);

            } catch (error) {
                console.error('Error loading graph data:', error);
            }
        }

        function createStepsChart(labels, data) {
            const ctx = document.getElementById('stepsChart');
            if (stepsChart) stepsChart.destroy();
            
            stepsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Steps',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: value => value.toLocaleString() }
                        }
                    }
                }
            });
        }

        function createHeartRateChart(labels, data) {
            const ctx = document.getElementById('heartRateChart');
            if (heartRateChart) heartRateChart.destroy();
            
            heartRateChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Heart Rate',
                        data: data,
                        borderColor: 'rgba(245, 87, 108, 1)',
                        backgroundColor: 'rgba(245, 87, 108, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: false, min: 40, max: 120 } }
                }
            });
        }

        async function createCaloriesChart() {
            const today = new Date().toISOString().split('T')[0];
            const { data } = await supabase
                .from('daily_tracker')
                .select('calories_burned')
                .eq('user_id', currentUserId)
                .eq('date', today)
                .single();

            const todayCalories = data?.calories_burned || 0;
            const remaining = Math.max(calorieGoal - todayCalories, 0);

            const ctx = document.getElementById('caloriesChart');
            if (caloriesChart) caloriesChart.destroy();
            
            caloriesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [todayCalories, remaining],
                        backgroundColor: ['rgba(250, 112, 154, 1)', 'rgba(230, 230, 230, 0.3)'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                },
                plugins: [{
                    id: 'centerText',
                    beforeDraw: function(chart) {
                        const width = chart.width;
                        const height = chart.height;
                        const ctx = chart.ctx;
                        ctx.restore();
                        
                        const fontSize = (height / 100).toFixed(2);
                        ctx.font = `bold ${fontSize}em sans-serif`;
                        ctx.textBaseline = 'middle';
                        ctx.fillStyle = '#333';
                        
                        const text = `${todayCalories}`;
                        const textX = Math.round((width - ctx.measureText(text).width) / 2);
                        const textY = height / 2 - 10;
                        ctx.fillText(text, textX, textY);
                        
                        ctx.font = `${fontSize * 0.5}em sans-serif`;
                        ctx.fillStyle = '#666';
                        const subtext = `of ${calorieGoal} cal`;
                        const subtextX = Math.round((width - ctx.measureText(subtext).width) / 2);
                        ctx.fillText(subtext, subtextX, textY + 20);
                        ctx.save();
                    }
                }]
            });
        }

        function createBloodPressureChart(labels, data) {
            const ctx = document.getElementById('bloodPressureChart');
            if (bloodPressureChart) bloodPressureChart.destroy();
            
            bloodPressureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Systolic BP',
                        data: data,
                        borderColor: 'rgba(79, 172, 254, 1)',
                        backgroundColor: 'rgba(79, 172, 254, 0.2)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: false, min: 90, max: 160 } }
                }
            });
        }

        function createSleepChart(labels, data) {
            const ctx = document.getElementById('sleepChart');
            if (sleepChart) sleepChart.destroy();
            
            sleepChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sleep',
                        data: data,
                        backgroundColor: 'rgba(118, 75, 162, 0.8)',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 12,
                            ticks: { callback: value => value + 'h' }
                        }
                    }
                }
            });
        }

        function updateCalorieGoal() {
            const newGoal = parseInt(document.getElementById('calorieGoalInput').value);
            if (newGoal && newGoal > 0) {
                calorieGoal = newGoal;
                localStorage.setItem('calorieGoal', calorieGoal);
                createCaloriesChart();
                showMessage('Calorie goal updated successfully', 'success');
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const formData = {
                user_id: currentUserId,
                date: document.getElementById('entry_date').value,
                heart_rate: document.getElementById('heart_rate').value ? parseInt(document.getElementById('heart_rate').value) : null,
                blood_pressure: document.getElementById('blood_pressure').value || null,
                sleep_cycles_hours: document.getElementById('sleep_cycles_hours').value ? parseFloat(document.getElementById('sleep_cycles_hours').value) : null,
                steps: document.getElementById('steps').value ? parseInt(document.getElementById('steps').value) : null,
                calories_burned: document.getElementById('calories_burned').value ? parseInt(document.getElementById('calories_burned').value) : null
            };

            if (!formData.heart_rate && !formData.blood_pressure && !formData.sleep_cycles_hours && !formData.steps && !formData.calories_burned) {
                showMessage('Please fill in at least one health metric', 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                const { error } = await supabase
                    .from('daily_tracker')
                    .upsert(formData, { onConflict: 'user_id,date' });

                if (error) throw error;

                showMessage('Entry saved successfully', 'success');
                loadAllData();
                loadTodayEntry();
                loadStats();
                loadGraphData();
                
            } catch (error) {
                console.error('Error saving entry:', error);
                showMessage(error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Entry';
            }
        }

        async function exportPDF(period) {
            try {
                showMessage(`Generating ${period} report...`, 'success');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let data = [];
                let title = '';
                const now = new Date();
                
                if (period === 'weekly') {
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    data = allUserData.filter(d => new Date(d.date) >= weekAgo);
                    title = 'Weekly Health Report';
                } else if (period === 'monthly') {
                    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    data = allUserData.filter(d => new Date(d.date) >= monthAgo);
                    title = 'Monthly Health Report';
                } else if (period === 'yearly') {
                    const yearAgo = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                    data = allUserData.filter(d => new Date(d.date) >= yearAgo);
                    title = 'Yearly Health Report';
                }
                
                if (data.length === 0) {
                    showMessage(`No data available for ${period} report`, 'error');
                    return;
                }
                
                // Title
                doc.setFontSize(20);
                doc.setTextColor(75, 63, 166);
                doc.text(title, 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(`Generated: ${now.toLocaleDateString()}`, 105, 28, { align: 'center' });
                doc.text(`Period: ${data.length} days of data`, 105, 33, { align: 'center' });
                
                // Calculate averages
                const avgHeartRate = Math.round(data.filter(d => d.heart_rate).reduce((sum, d) => sum + d.heart_rate, 0) / data.filter(d => d.heart_rate).length) || 0;
                const avgSleep = (data.filter(d => d.sleep_cycles_hours).reduce((sum, d) => sum + parseFloat(d.sleep_cycles_hours), 0) / data.filter(d => d.sleep_cycles_hours).length).toFixed(1) || 0;
                const avgSteps = Math.round(data.filter(d => d.steps).reduce((sum, d) => sum + d.steps, 0) / data.filter(d => d.steps).length) || 0;
                const avgCalories = Math.round(data.filter(d => d.calories_burned).reduce((sum, d) => sum + d.calories_burned, 0) / data.filter(d => d.calories_burned).length) || 0;
                
                // Summary section
                doc.setFontSize(14);
                doc.setTextColor(75, 63, 166);
                doc.text('Health Summary', 20, 45);
                
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                let y = 55;
                
                doc.text(`Average Heart Rate: ${avgHeartRate} bpm`, 20, y);
                y += 8;
                doc.text(`Average Sleep: ${avgSleep} hours`, 20, y);
                y += 8;
                doc.text(`Average Steps: ${avgSteps.toLocaleString()} steps`, 20, y);
                y += 8;
                doc.text(`Average Calories Burned: ${avgCalories} kcal`, 20, y);
                y += 15;
                
                // Daily entries
                doc.setFontSize(14);
                doc.setTextColor(75, 63, 166);
                doc.text('Daily Entries', 20, y);
                y += 10;
                
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                
                // Limit to most recent 20 entries for readability
                const displayData = data.slice(0, 20);
                
                displayData.forEach((entry, index) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    const date = new Date(entry.date).toLocaleDateString();
                    doc.setFont(undefined, 'bold');
                    doc.text(`${date}`, 20, y);
                    doc.setFont(undefined, 'normal');
                    
                    let details = [];
                    if (entry.heart_rate) details.push(`HR: ${entry.heart_rate} bpm`);
                    if (entry.blood_pressure) details.push(`BP: ${entry.blood_pressure}`);
                    if (entry.sleep_cycles_hours) details.push(`Sleep: ${entry.sleep_cycles_hours}h`);
                    if (entry.steps) details.push(`Steps: ${entry.steps}`);
                    if (entry.calories_burned) details.push(`Cal: ${entry.calories_burned}`);
                    
                    doc.text(details.join(' | '), 55, y);
                    y += 7;
                });
                
                if (data.length > 20) {
                    y += 5;
                    doc.setTextColor(100, 100, 100);
                    doc.text(`... and ${data.length - 20} more entries`, 20, y);
                }
                
                // Footer
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text('HealthHub Connect - Your Health, Your Data', 105, 285, { align: 'center' });
                
                // Save PDF
                doc.save(`HealthHub_${period}_report_${now.toISOString().split('T')[0]}.pdf`);
                
                showMessage(`${period.charAt(0).toUpperCase() + period.slice(1)} report downloaded successfully`, 'success');
                
            } catch (error) {
                console.error('PDF export error:', error);
                showMessage('Error generating PDF report', 'error');
            }
        }

        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        function handleAuth() {
            window.location.href = 'signin.html';
        }

        async function signOut() {
            await supabase.auth.signOut();
            window.location.reload();
        }

        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
                checkAuth();
            }
        });
    </script>
</body>
</html>

