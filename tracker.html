
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Tracker - Healthub Connect</title>
    <link rel="stylesheet" href="index_styles.css">
    <style>
        section {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .tracker-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        @media (max-width: 768px) {
            .tracker-container {
                grid-template-columns: 1fr;
            }
        }
        .tracker-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .tracker-card h3 {
            margin-top: 0;
            color: #4b3fa6;
            border-bottom: 2px solid #4b3fa6;
            padding-bottom: 10px;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #aaa;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        .form-group input:focus {
            outline: none;
            border-color: #4b3fa6;
            box-shadow: 0 0 0 2px rgba(75, 63, 166, 0.2);
        }
        .btn-primary {
            background: #4b3fa6;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
            transition: 0.25s ease;
        }
        .btn-primary:hover {
            background: #3a2f88;
            transform: translateY(-1px);
        }
        .btn-primary:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        .message {
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
            text-align: center;
        }
        .message.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .message.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .history-card {
            background: #f9f9f9;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #4b3fa6;
        }
        .history-card .date {
            font-weight: bold;
            color: #4b3fa6;
            margin-bottom: 8px;
        }
        .history-card .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .metric {
            background: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 13px;
        }
        .metric-label {
            color: #666;
            font-size: 11px;
        }
        .metric-value {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }
        .login-prompt {
            text-align: center;
            padding: 40px;
        }
        .current-entry {
            background: #e6f3ff;
            border: 2px solid #4b3fa6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .current-entry h4 {
            margin-top: 0;
            color: #4b3fa6;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="Title">
        <h1>Health Tracker</h1>
        <div id="userInfo" style="margin:0; text-align: center;"></div>
    </div>
    
    <div class="top-bar">
        <button class="signin-btn" id="authButton" onclick="handleAuth()">Sign In</button>
    </div>
    
    <hr>
    
    <h2 class="Navigations">
        <a href="index.html">Home</a>
        <a href="documents.html">Documents</a>
        <a href="tracker.html">Trackers</a>
        <a href="assistant.html">AI Health Assistant</a>
        <a href="appointments.html">Appointments</a>
        <a href="insurance.html">Insurance Hub</a>
        <a href="summaries.html">Visit Summaries</a>
        <a href="family.html">Family Access</a>
        <a href="payments.html">Payments</a>
        <a href="support.html">Support Call Center</a>
        <a href="links.html">Helpful Links</a>
        <a href="about.html">About</a>
    </h2>
    
    <hr>
    
    <section>
        <div id="content">
            <!-- Content will be loaded based on auth status -->
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        const supabaseUrl = 'https://hbtgwzneuhdqlmriwvje.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhidGd3em5ldWhkcWxtcml3dmplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNDI5MTQsImV4cCI6MjA3NTkxODkxNH0.1v1OLYSEPRBKaZWQu1sJo8DoRzYePfdc7Zcs8i8TF78';
        
        let supabase;
        let currentUserId;

        document.addEventListener('DOMContentLoaded', function() {
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            console.log('Supabase initialized');
            checkAuth();
        });

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            const authButton = document.getElementById('authButton');
            const userInfo = document.getElementById('userInfo');
            const content = document.getElementById('content');

            if (session) {
                currentUserId = session.user.id;
                console.log('User is authenticated:', currentUserId);
                
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('first_name, last_name')
                    .eq('user_id', currentUserId)
                    .single();

                const firstName = profile?.first_name || session.user.email;
                userInfo.innerHTML = `Hello, ${firstName} — <a href="#" onclick="signOut(); return false;">Sign Out</a>`;
                authButton.style.display = 'none';
                
                content.innerHTML = `
                    <h2>Daily Health Tracker</h2>
                    <p>Track your vital signs and health metrics every day.</p>
                    
                    <div id="messageArea"></div>
                    
                    <div id="todayEntry"></div>
                    
                    <div id="statsArea"></div>
                    
                    <div class="tracker-container">
                        <div class="tracker-card">
                            <h3> Enter Today's Data</h3>
                            <form id="trackerForm">
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" id="entry_date" name="entry_date" required>
                                </div>
                                
                                <div class="form-group">
                                    <label>Heart Rate (bpm)</label>
                                    <input type="number" id="heart_rate" name="heart_rate" placeholder="e.g., 72" min="30" max="200">
                                </div>
                                
                                <div class="form-group">
                                    <label>Blood Pressure (systolic/diastolic)</label>
                                    <input type="text" id="blood_pressure" name="blood_pressure" placeholder="e.g., 120/80" pattern="[0-9]{2,3}/[0-9]{2,3}">
                                </div>
                                
                                <div class="form-group">
                                    <label>Sleep Hours</label>
                                    <input type="number" id="sleep_cycles_hours" name="sleep_cycles_hours" placeholder="e.g., 7.5" step="0.5" min="0" max="24">
                                </div>
                                
                                <div class="form-group">
                                    <label>Steps</label>
                                    <input type="number" id="steps" name="steps" placeholder="e.g., 8000" min="0">
                                </div>
                                
                                <div class="form-group">
                                    <label>Calories Burned</label>
                                    <input type="number" id="calories_burned" name="calories_burned" placeholder="e.g., 2000" min="0">
                                </div>
                                
                                <button type="submit" class="btn-primary" id="submitBtn">Save Entry</button>
                            </form>
                        </div>
                        
                        <div class="tracker-card">
                            <h3> Recent History (Last 7 Days)</h3>
                            <div id="historyList">
                                <p>Loading history...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tracker-card" style="margin-top: 20px;">
                        <h3> All Entries</h3>
                        <div id="allHistory">
                            <p>Loading all entries...</p>
                        </div>
                    </div>
                `;
                
                // Set today's date as default
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('entry_date').value = today;
                
                // Set up form handler
                document.getElementById('trackerForm').addEventListener('submit', handleSubmit);
                
                // Load data
                loadTodayEntry();
                loadHistory();
                loadStats();
                
            } else {
                console.log('User is not authenticated');
                userInfo.innerHTML = '';
                authButton.style.display = 'block';
                authButton.textContent = 'Sign In';
                
                content.innerHTML = `
                    <div class="login-prompt">
                        <h3>Please Sign In to Track Your Health</h3>
                        <p>You need to be logged in to track your daily health metrics.</p>
                        <button onclick="handleAuth()" class="signin-btn">Sign In</button>
                    </div>
                `;
            }
        }

        async function loadTodayEntry() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const { data, error } = await supabase
                    .from('daily_tracker')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .eq('date', today)
                    .single();

                const todayEntry = document.getElementById('todayEntry');
                
                if (data && !error) {
                    todayEntry.innerHTML = `
                        <div class="current-entry">
                            <h4> Today's Entry (${new Date(data.date).toLocaleDateString()})</h4>
                            <div class="metrics">
                                ${data.heart_rate ? `<span>❤️ Heart Rate: <strong>${data.heart_rate} bpm</strong></span> | ` : ''}
                                ${data.blood_pressure ? `<span>🩺 BP: <strong>${data.blood_pressure}</strong></span> | ` : ''}
                                ${data.sleep_cycles_hours ? `<span>😴 Sleep: <strong>${data.sleep_cycles_hours} hrs</strong></span> | ` : ''}
                                ${data.steps ? `<span>👟 Steps: <strong>${data.steps}</strong></span> | ` : ''}
                                ${data.calories_burned ? `<span>🔥 Calories: <strong>${data.calories_burned}</strong></span>` : ''}
                            </div>
                            <p style="margin-top: 10px; font-size: 13px; color: #666;">You can update today's entry by submitting the form again.</p>
                        </div>
                    `;
                    
                    // Pre-fill form with today's data
                    if (data.heart_rate) document.getElementById('heart_rate').value = data.heart_rate;
                    if (data.blood_pressure) document.getElementById('blood_pressure').value = data.blood_pressure;
                    if (data.sleep_cycles_hours) document.getElementById('sleep_cycles_hours').value = data.sleep_cycles_hours;
                    if (data.steps) document.getElementById('steps').value = data.steps;
                    if (data.calories_burned) document.getElementById('calories_burned').value = data.calories_burned;
                }
            } catch (error) {
                console.log('No entry for today yet');
            }
        }

        async function loadStats() {
            try {
                const { data, error } = await supabase
                    .from('daily_tracker')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .order('date', { ascending: false })
                    .limit(30);

                if (error) throw error;

                const statsArea = document.getElementById('statsArea');
                
                if (data && data.length > 0) {
                    // Calculate averages
                    const avgHeartRate = Math.round(data.filter(d => d.heart_rate).reduce((sum, d) => sum + d.heart_rate, 0) / data.filter(d => d.heart_rate).length);
                    const avgSleep = (data.filter(d => d.sleep_cycles_hours).reduce((sum, d) => sum + parseFloat(d.sleep_cycles_hours), 0) / data.filter(d => d.sleep_cycles_hours).length).toFixed(1);
                    const avgSteps = Math.round(data.filter(d => d.steps).reduce((sum, d) => sum + d.steps, 0) / data.filter(d => d.steps).length);
                    const avgCalories = Math.round(data.filter(d => d.calories_burned).reduce((sum, d) => sum + d.calories_burned, 0) / data.filter(d => d.calories_burned).length);
                    
                    statsArea.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Avg Heart Rate</div>
                                <div class="stat-value">${avgHeartRate || 0}</div>
                                <div class="stat-label">bpm (30 days)</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <div class="stat-label">Avg Sleep</div>
                                <div class="stat-value">${avgSleep || 0}</div>
                                <div class="stat-label">hours (30 days)</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                <div class="stat-label">Avg Steps</div>
                                <div class="stat-value">${avgSteps || 0}</div>
                                <div class="stat-label">steps (30 days)</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                                <div class="stat-label">Avg Calories</div>
                                <div class="stat-value">${avgCalories || 0}</div>
                                <div class="stat-label">kcal (30 days)</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadHistory() {
            try {
                // Last 7 days
                const { data: recentData, error: recentError } = await supabase
                    .from('daily_tracker')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .order('date', { ascending: false })
                    .limit(7);

                if (recentError) throw recentError;

                const historyList = document.getElementById('historyList');
                
                if (!recentData || recentData.length === 0) {
                    historyList.innerHTML = '<p>No entries yet. Start tracking today!</p>';
                } else {
                    historyList.innerHTML = recentData.map(entry => `
                        <div class="history-card">
                            <div class="date">${new Date(entry.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div>
                            <div class="metrics">
                                ${entry.heart_rate ? `<div class="metric"><div class="metric-label">Heart Rate</div><div class="metric-value">${entry.heart_rate} bpm</div></div>` : ''}
                                ${entry.blood_pressure ? `<div class="metric"><div class="metric-label">Blood Pressure</div><div class="metric-value">${entry.blood_pressure}</div></div>` : ''}
                                ${entry.sleep_cycles_hours ? `<div class="metric"><div class="metric-label">Sleep</div><div class="metric-value">${entry.sleep_cycles_hours} hrs</div></div>` : ''}
                                ${entry.steps ? `<div class="metric"><div class="metric-label">Steps</div><div class="metric-value">${entry.steps.toLocaleString()}</div></div>` : ''}
                                ${entry.calories_burned ? `<div class="metric"><div class="metric-label">Calories</div><div class="metric-value">${entry.calories_burned}</div></div>` : ''}
                            </div>
                        </div>
                    `).join('');
                }

                // All entries
                const { data: allData, error: allError } = await supabase
                    .from('daily_tracker')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .order('date', { ascending: false });

                if (allError) throw allError;

                const allHistory = document.getElementById('allHistory');
                
                if (!allData || allData.length === 0) {
                    allHistory.innerHTML = '<p>No entries yet.</p>';
                } else {
                    allHistory.innerHTML = `
                        <p style="margin-bottom: 15px;">Total Entries: <strong>${allData.length}</strong></p>
                        ${allData.map(entry => `
                            <div class="history-card">
                                <div class="date">${new Date(entry.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                                <div class="metrics">
                                    ${entry.heart_rate ? `<div class="metric"><div class="metric-label">Heart Rate</div><div class="metric-value">${entry.heart_rate} bpm</div></div>` : ''}
                                    ${entry.blood_pressure ? `<div class="metric"><div class="metric-label">Blood Pressure</div><div class="metric-value">${entry.blood_pressure}</div></div>` : ''}
                                    ${entry.sleep_cycles_hours ? `<div class="metric"><div class="metric-label">Sleep</div><div class="metric-value">${entry.sleep_cycles_hours} hrs</div></div>` : ''}
                                    ${entry.steps ? `<div class="metric"><div class="metric-label">Steps</div><div class="metric-value">${entry.steps.toLocaleString()}</div></div>` : ''}
                                    ${entry.calories_burned ? `<div class="metric"><div class="metric-label">Calories</div><div class="metric-value">${entry.calories_burned}</div></div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    `;
                }

            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('historyList').innerHTML = '<p>Error loading history.</p>';
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const formData = {
                user_id: currentUserId,
                date: document.getElementById('entry_date').value,
                heart_rate: document.getElementById('heart_rate').value ? parseInt(document.getElementById('heart_rate').value) : null,
                blood_pressure: document.getElementById('blood_pressure').value || null,
                sleep_cycles_hours: document.getElementById('sleep_cycles_hours').value ? parseFloat(document.getElementById('sleep_cycles_hours').value) : null,
                steps: document.getElementById('steps').value ? parseInt(document.getElementById('steps').value) : null,
                calories_burned: document.getElementById('calories_burned').value ? parseInt(document.getElementById('calories_burned').value) : null
            };

            // Validate that at least one field is filled
            if (!formData.heart_rate && !formData.blood_pressure && !formData.sleep_cycles_hours && !formData.steps && !formData.calories_burned) {
                showMessage('Please fill in at least one health metric.', 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                // Use upsert to update if entry exists for this date
                const { error } = await supabase
                    .from('daily_tracker')
                    .upsert(formData, {
                        onConflict: 'user_id,date'
                    });

                if (error) throw error;

                showMessage('Entry saved successfully!', 'success');
                
                // Reload data
                loadTodayEntry();
                loadHistory();
                loadStats();
                
            } catch (error) {
                console.error('Error saving entry:', error);
                showMessage(`${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Entry';
            }
        }

        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        function handleAuth() {
            window.location.href = 'signin.html';
        }

        async function signOut() {
            await supabase.auth.signOut();
            window.location.reload();
        }

        supabase.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event);
            if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
                checkAuth();
            }
        });
    </script>
</body>
</html>

