<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Health Assistant - Healthub Connect</title>
  <link rel="stylesheet" href="index_styles.css"/>
<style>
    section {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .chat-wrapper {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        min-height: 60vh;
        max-height: 75vh;
    }

    .chat-header {
        padding: 14px 16px;
        border-bottom: 1px solid #e5e5e5;
        color: #4b3fa6;
        font-weight: 700;
    }

    .chat-body {
        padding: 16px;
        overflow-y: auto;
        flex: 1;
        background: #f7f7fb;
    }

    .chat-footer {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        padding: 12px;
        border-top: 1px solid #e5e5e5;
        background: #fafafa;
    }

    .chat-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #aaa;
        border-radius: 6px;
        font-size: 14px;
    }

    .send-btn {
        background: #4b3fa6;
        color: #fff;
        border: none;
        padding: 12px 18px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
    }

    .msg {
        display: flex;
        margin: 10px 0;
        max-width: 90%;
    }

    .msg.user {
        justify-content: flex-end;
    }

    .msg.ai {
        justify-content: flex-start;
    }

    .bubble {
        padding: 12px 14px;
        border-radius: 14px;
        font-size: 14px;
        white-space: pre-wrap;
    }

    .bubble.user {
        background: #f2f2f7;
    }

    .bubble.ai {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .login-prompt {
        text-align: center;
        padding: 40px;
    }
</style>
</head>
<body>
  <div class="Title">
    <h1>AI Health Assistant</h1>
    <div id="userInfo" style="margin:0; text-align: center;"></div>
  </div>

  <div class="top-bar">
    <button class="signin-btn" id="authButton">Sign In</button>
  </div>

  <hr/>

  <h2 class="Navigations">
    <a href="index.html">Home</a>
    <a href="documents.html">Documents</a>
    <a href="tracker.html">Trackers</a>
    <a href="assistant.html">AI Health Assistant</a>
    <a href="appointments.html">Appointments</a>
    <a href="insurance.html">Insurance Hub</a>
    <a href="summaries.html">Visit Summaries</a>
    <a href="family.html">Family Access</a>
    <a href="payments.html">Payments</a>
    <a href="support.html">Support Call Center</a>
    <a href="links.html">Helpful Links</a>
    <a href="about.html">About</a>
  </h2>

  <hr/>

  <section><div id="content"></div></section>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase.createClient(
      'https://hbtgwzneuhdqlmriwvje.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhidGd3em5ldWhkcWxtcml3dmplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNDI5MTQsImV4cCI6MjA3NTkxODkxNH0.1v1OLYSEPRBKaZWQu1sJo8DoRzYePfdc7Zcs8i8TF78',
      { auth: { persistSession: true, autoRefreshToken: true } }
    );

    const AI_FUNCTION_URL = 'https://hbtgwzneuhdqlmriwvje.supabase.co/functions/v1/ai-chat-index-ts';
    let convo = [];

async function checkAuth() {
  const { data: { session } } = await supabase.auth.getSession();
  const userInfo = document.getElementById('userInfo');
  const authButton = document.getElementById('authButton');
  const content = document.getElementById('content');

  if (!session) {
    userInfo.innerHTML = '';
    authButton.style.display = 'block';
    authButton.onclick = () => location.href = 'signin.html';
    content.innerHTML = `
      <div class="login-prompt">
        <h3>Please Sign In to use the AI Health Assistant</h3>
        <p>You need to be logged in to communicate with the AI Chatbot Health Assistant.</p>
        <button class="signin-btn" onclick="location.href='signin.html'">Sign In</button>
      </div>`;
  } else {
    authButton.style.display = 'none';

    const firstName = session.user.user_metadata?.first_name || session.user.email;
    userInfo.innerHTML = `Hello, ${firstName} â€” <a href="#" onclick="logout()">Sign Out</a>`;

    loadChatUI();
  }
}

function loadChatUI() {
  document.getElementById('content').innerHTML = `
    <div class="chat-wrapper">
      <div class="chat-header">Chat with HealthHub AI</div>
      <div id="chatBody" class="chat-body"></div>
      <div class="chat-footer">
        <input id="chatInput" class="chat-input" placeholder="Ask a health question..."/>
        <button id="sendBtn" class="send-btn">Send</button>
      </div>
    </div>`;

  document.getElementById('sendBtn').onclick = handleSend;

  // AI greeting message when the chat loads
  addMessage('ai', "Hello! I'm your AI Health Assistant. I can help answer health questions and guide you with medical information. How can I assist you today?");
  
  // The AI's behavior, as well as its memory.
  convo.push({
    role: "system",
    content: "You are a helpful medical assistant. Answer only health-related questions in short, clear responses. If a user asks a non-medical or unrelated question, politely decline and explain you only handle health-related topics."
  });
}

    function addMessage(role, text) {
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      div.innerHTML = `<div class="bubble ${role}">${text}</div>`;
      const chatBody = document.getElementById('chatBody');
      chatBody.appendChild(div);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

async function handleSend() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;

  // Adds the user message on the screen
  addMessage('user', text);
  convo.push({ role: 'user', content: text });
  input.value = '';

  // Call AI with safety rules + medical focus
  await callAI();
}

async function callAI() {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    addMessage('ai', "You are signed out. Please sign in again.");
    return;
  }

  // This will ensure that the AI will stay on topic
  const messages = [
    {
      role: "system",
      content: "You are a professional medical assistant. Keep answers short, factual, direct, and medically accurate. You only answer medical-related questions. If a question is not medical, respond with: 'Sorry, I can only answer medical-related questions.' If a request is unsafe (self-harm, drugs, medical prescriptions, or illegal topics), respond with: 'I can't help with that. Please contact a licensed medical professional or emergency services if needed.' Never break character. Do not provide emotional therapy."
    },
    ...convo 
  ];

  try {
    const res = await fetch(AI_FUNCTION_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${session.access_token}`
      },
      body: JSON.stringify({ messages })
    });

    const json = await res.json();
    const reply = json.reply || "No response.";
    addMessage('ai', reply);
    convo.push({ role: 'assistant', content: reply });

  } catch (err) {
    console.error(err);
    addMessage('ai', "I had an issue processing your request. Try again.");
  }
}


    async function logout() {
      await supabase.auth.signOut();
      location.reload();
    }

    checkAuth();
  </script>
</body>
</html>
