<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medication Tracker - HealthHub Connect</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8fafc;
        }

        /* Header/Navigation */
        .header {
            background: #00d4d4;
            color: #1e293b;
            padding: 1.5rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: #1e293b;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .user-greeting {
            font-weight: 600;
            color: #1e293b;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .user-greeting:hover {
            background: rgba(30, 41, 59, 0.1);
        }

        .btn {
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
        }

        .btn-primary {
            background: #5b21b6;
            color: white;
        }

        .btn-primary:hover {
            background: #4c1d95;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(91, 33, 182, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: #1e293b;
            border: 2px solid #1e293b;
        }

        .btn-secondary:hover {
            background: #1e293b;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* Navigation Pills */
        .nav-section {
            background: white;
            padding: 20px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .nav-pills {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .nav-pills a {
            padding: 10px 20px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: 600;
            color: #5b21b6;
            background: #f1f5f9;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .nav-pills a:hover {
            background: #5b21b6;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(91, 33, 182, 0.3);
        }

        .nav-pills a.active {
            background: #5b21b6;
            color: white;
        }

        /* Main Content */
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .page-header h1 {
            color: #1e293b;
            margin-bottom: 10px;
            font-size: 32px;
            font-weight: 700;
        }

        .page-header p {
            color: #64748b;
            font-size: 16px;
        }

        /* Cards */
        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .card h2 {
            color: #5b21b6;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 700;
        }

        /* Calendar */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-header h2 {
            margin: 0;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav button {
            padding: 8px 16px;
            background: #5b21b6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        .calendar-nav button:hover {
            background: #4c1d95;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 700;
            color: #5b21b6;
            padding: 10px;
            font-size: 14px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            padding: 8px;
        }

        .calendar-day:hover {
            border-color: #5b21b6;
            background: #f8f5ff;
        }

        .calendar-day.other-month {
            opacity: 0.3;
            cursor: default;
        }

        .calendar-day.other-month:hover {
            border-color: #e5e5e5;
            background: white;
        }

        .calendar-day.today {
            border-color: #5b21b6;
            background: #f8f5ff;
            font-weight: 700;
        }

        .calendar-day.selected {
            background: #5b21b6;
            border-color: #5b21b6;
            color: white;
        }

        .calendar-day.has-medications {
            border-color: #ffc107;
            background: #fffbf0;
        }

        .calendar-day.has-medications.all-taken {
            border-color: #28a745;
            background: #f0fff4;
        }

        .calendar-day-number {
            font-size: 16px;
            font-weight: 600;
        }

        .calendar-day-indicator {
            width: 6px;
            height: 6px;
            background: #ffc107;
            border-radius: 50%;
            margin-top: 4px;
        }

        .calendar-day.has-medications.all-taken .calendar-day-indicator {
            background: #28a745;
        }

        /* Day Details */
        .day-details {
            margin-top: 20px;
        }

        .day-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e5e5;
        }

        .day-details-header h3 {
            color: #1e293b;
            font-size: 18px;
        }

        .medication-entry {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #5b21b6;
        }

        .medication-entry.taken {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .medication-entry.skipped {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .medication-info {
            flex: 1;
        }

        .medication-name {
            font-weight: 700;
            color: #1e293b;
            font-size: 18px;
            margin-bottom: 4px;
        }

        .medication-time {
            color: #5b21b6;
            font-weight: 600;
            font-size: 14px;
        }

        .medication-dosage {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .medication-actions {
            display: flex;
            gap: 8px;
        }

        /* Manage Medications Section */
        .medication-item {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #5b21b6;
        }

        .medication-item.inactive {
            opacity: 0.6;
            border-left-color: #94a3b8;
        }

        .medication-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .medication-header-name {
            font-weight: 700;
            font-size: 16px;
            color: #1e293b;
        }

        .medication-header-dosage {
            color: #64748b;
            font-size: 14px;
        }

        .medication-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
            font-size: 13px;
        }

        .medication-detail {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            color: #64748b;
            font-size: 12px;
        }

        .detail-value {
            color: #1e293b;
            font-weight: 600;
        }

        /* Form Styles */
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1e293b;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            margin-bottom: 20px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #5b21b6;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .calendar-grid {
                gap: 5px;
            }
            
            .calendar-day {
                padding: 4px;
            }
            
            .calendar-day-number {
                font-size: 14px;
            }
        }

        .time-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        .time-input-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .time-input-group input {
            width: 120px;
            margin-bottom: 0;
        }

        .time-input-group button {
            padding: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-state h3 {
            color: #1e293b;
            margin-bottom: 10px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #64748b;
            line-height: 1;
        }

        .close-modal:hover {
            color: #1e293b;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 20px;
            color: #64748b;
        }

        /* Message */
        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Footer */
        .footer {
            background: #1e293b;
            color: white;
            text-align: center;
            padding: 30px 20px;
            margin-top: 60px;
        }

        .footer p {
            margin: 5px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-text">HealthHub Connect</div>
            <div class="user-info">
                <span class="user-greeting" id="userGreeting"></span>
                <button id="authButton" class="btn btn-secondary">Sign In</button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav-section">
        <div class="nav-pills">
            <a href="index.html">Home</a>
            <a href="documents.html">Documents</a>
            <a href="tracker.html">Health Tracker</a>
            <a href="appointments.html">Appointments</a>
            <a href="medications.html" class="active">Medications</a>
            <a href="profile.html">Profile</a>
            <a href="support.html">Support</a>
            <a href="about.html">About</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>Medication Tracker</h1>
            <p>View your medication schedule by day</p>
        </div>

        <!-- Calendar Card -->
        <div class="card">
            <div class="calendar-header">
                <h2 id="calendarMonth">November 2025</h2>
                <div class="calendar-nav">
                    <button onclick="previousMonth()">Previous</button>
                    <button onclick="nextMonth()">Next</button>
                    <button onclick="goToToday()">Today</button>
                </div>
            </div>

            <!-- Calendar Grid -->
            <div class="calendar-grid">
                <div class="calendar-day-header">Sun</div>
                <div class="calendar-day-header">Mon</div>
                <div class="calendar-day-header">Tue</div>
                <div class="calendar-day-header">Wed</div>
                <div class="calendar-day-header">Thu</div>
                <div class="calendar-day-header">Fri</div>
                <div class="calendar-day-header">Sat</div>
            </div>
            <div id="calendarDays" class="calendar-grid"></div>

            <!-- Selected Day Details -->
            <div id="dayDetails" class="day-details" style="display: none;">
                <div class="day-details-header">
                    <h3 id="selectedDayTitle">Medications for Today</h3>
                </div>
                <div id="dayMedications">
                    <div class="loading">Loading medications...</div>
                </div>
            </div>
        </div>

        <!-- Manage Medications -->
        <div class="card">
            <h2>Manage Medications</h2>
            <button onclick="openAddMedicationModal()" class="btn btn-primary" style="margin-bottom: 20px;">Add New Medication</button>
            <div id="medicationsList">
                <div class="loading">Loading medications...</div>
            </div>
        </div>
    </div>

    <!-- Add Medication Modal -->
    <div id="addMedicationModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAddMedicationModal()">&times;</span>
            <h3>Add New Medication</h3>
            <div id="addMessage"></div>
            <form id="medicationForm" onsubmit="addMedication(event)">
                <div class="form-row">
                    <div>
                        <label>Medication Name *</label>
                        <input type="text" id="medicationName" required placeholder="e.g., Aspirin">
                    </div>
                    <div>
                        <label>Dosage *</label>
                        <input type="text" id="dosage" required placeholder="e.g., 100mg">
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label>Frequency *</label>
                        <select id="frequency" required>
                            <option value="">Select frequency...</option>
                            <option value="once daily">Once Daily</option>
                            <option value="twice daily">Twice Daily</option>
                            <option value="three times daily">Three Times Daily</option>
                            <option value="every 4 hours">Every 4 Hours</option>
                            <option value="every 6 hours">Every 6 Hours</option>
                            <option value="every 8 hours">Every 8 Hours</option>
                            <option value="every 12 hours">Every 12 Hours</option>
                            <option value="as needed">As Needed</option>
                        </select>
                    </div>
                    <div>
                        <label>Start Date *</label>
                        <input type="date" id="startDate" required>
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label>End Date / Refill Date</label>
                        <input type="date" id="endDate">
                        <small style="color: #64748b; font-size: 12px;">Leave empty for ongoing medication</small>
                    </div>
                    <div>
                        <label>Duration (days)</label>
                        <input type="number" id="durationDays" placeholder="e.g., 30" min="1">
                        <small style="color: #64748b; font-size: 12px;">Or specify number of days</small>
                    </div>
                </div>

                <div>
                    <label>Time(s) of Day *</label>
                    <div class="time-inputs" id="timeInputs">
                        <div class="time-input-group">
                            <input type="time" class="time-input" value="08:00" required>
                        </div>
                    </div>
                    <button type="button" onclick="addTimeInput()" class="btn btn-secondary btn-small">Add Time</button>
                </div>

                <div class="form-row">
                    <div>
                        <label>Prescribing Doctor</label>
                        <input type="text" id="prescribingDoctor" placeholder="Optional">
                    </div>
                    <div>
                        <label>Pharmacy Name</label>
                        <input type="text" id="pharmacyName" placeholder="Optional">
                    </div>
                </div>

                <div>
                    <label>Notes</label>
                    <textarea id="notes" rows="3" placeholder="Any special instructions..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">Add Medication</button>
                    <button type="button" onclick="closeAddMedicationModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p><strong>HealthHub Connect</strong></p>
        <p>Your health, your data, your peace of mind</p>
        <p>&copy; 2025 HealthHub Connect. All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        const supabaseUrl = 'https://hbtgwzneuhdqlmriwvje.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhidGd3em5ldWhkcWxtcml3dmplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNDI5MTQsImV4cCI6MjA3NTkxODkxNH0.1v1OLYSEPRBKaZWQu1sJo8DoRzYePfdc7Zcs8i8TF78';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        let currentUser = null;
        let currentDate = new Date();
        let selectedDate = new Date();
        let scheduleData = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuth();
        });

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            const userGreeting = document.getElementById('userGreeting');
            const authButton = document.getElementById('authButton');
            
            if (session && session.user) {
                currentUser = session.user;
                const firstName = session.user.user_metadata?.first_name || 
                                 session.user.email.split('@')[0];
                userGreeting.textContent = `Hello, ${firstName}!`;
                userGreeting.onclick = function() {
                    window.location.href = 'profile.html';
                };
                authButton.textContent = 'Sign Out';
                authButton.onclick = async function() {
                    await supabase.auth.signOut();
                    window.location.href = 'index.html';
                };
                
                // Load data
                await loadMedications();
                await renderCalendar();
                selectDate(new Date());
            } else {
                userGreeting.textContent = '';
                authButton.textContent = 'Sign In';
                authButton.onclick = function() {
                    window.location.href = 'signin.html';
                };
                
                document.querySelector('.container').innerHTML = `
                    <div class="empty-state" style="padding: 100px 20px;">
                        <h3>Please Sign In</h3>
                        <p>You need to be logged in to track your medications.</p>
                        <button onclick="window.location.href='signin.html'" class="btn btn-primary">Sign In</button>
                    </div>
                `;
            }
        }

        // Calendar Functions
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            selectedDate = new Date();
            renderCalendar();
            selectDate(selectedDate);
        }

        async function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            // Load schedule data for this month
            await loadMonthSchedule(year, month);
            
            // Build calendar
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
            
            const today = new Date();
            const todayStr = formatDate(today);
            
            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const dayDiv = createDayElement(day, true, year, month - 1);
                calendarDays.appendChild(dayDiv);
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = formatDate(date);
                const isToday = dateStr === todayStr;
                const isSelected = formatDate(selectedDate) === dateStr;
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                
                if (isToday) dayDiv.classList.add('today');
                if (isSelected) dayDiv.classList.add('selected');
                
                // Check if this day has medications
                const daySchedule = scheduleData[dateStr];
                if (daySchedule && daySchedule.length > 0) {
                    dayDiv.classList.add('has-medications');
                    
                    // Check if all taken
                    const allTaken = daySchedule.every(item => item.is_taken || item.skipped);
                    if (allTaken) {
                        dayDiv.classList.add('all-taken');
                    }
                }
                
                dayDiv.innerHTML = `
                    <span class="calendar-day-number">${day}</span>
                    ${daySchedule && daySchedule.length > 0 ? '<span class="calendar-day-indicator"></span>' : ''}
                `;
                
                dayDiv.onclick = () => selectDate(new Date(year, month, day));
                calendarDays.appendChild(dayDiv);
            }
            
            // Next month days
            const totalCells = calendarDays.children.length;
            const remainingCells = 42 - totalCells; // 6 rows * 7 days
            for (let day = 1; day <= remainingCells; day++) {
                const dayDiv = createDayElement(day, true, year, month + 1);
                calendarDays.appendChild(dayDiv);
            }
        }

        function createDayElement(day, otherMonth, year, month) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day other-month';
            dayDiv.innerHTML = `<span class="calendar-day-number">${day}</span>`;
            return dayDiv;
        }

        async function loadMonthSchedule(year, month) {
            try {
                const startDate = new Date(year, month, 1);
                const endDate = new Date(year, month + 1, 0);
                
                const { data, error } = await supabase
                    .from('medication_schedule')
                    .select(`
                        *,
                        medications (medication_name, dosage)
                    `)
                    .eq('user_id', currentUser.id)
                    .gte('scheduled_date', formatDate(startDate))
                    .lte('scheduled_date', formatDate(endDate))
                    .order('scheduled_time', { ascending: true });

                if (error) throw error;

                // Group by date and deduplicate
                scheduleData = {};
                if (data) {
                    data.forEach(item => {
                        const dateStr = item.scheduled_date;
                        if (!scheduleData[dateStr]) {
                            scheduleData[dateStr] = [];
                        }
                        
                        // Check if this exact medication+time combo already exists for this date
                        const exists = scheduleData[dateStr].find(existing => 
                            existing.medications.medication_name === item.medications.medication_name &&
                            existing.medications.dosage === item.medications.dosage &&
                            existing.scheduled_time === item.scheduled_time
                        );
                        
                        if (!exists) {
                            // New unique entry
                            scheduleData[dateStr].push(item);
                        } else if (item.is_taken || item.skipped) {
                            // Update if this one is taken/skipped and the existing one isn't
                            if (!exists.is_taken && !exists.skipped) {
                                const index = scheduleData[dateStr].indexOf(exists);
                                scheduleData[dateStr][index] = item;
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading schedule:', error);
            }
        }

        function selectDate(date) {
            selectedDate = new Date(date);
            renderCalendar();
            loadDayMedications(date);
        }

        function loadDayMedications(date) {
            const dateStr = formatDate(date);
            const dayMeds = scheduleData[dateStr] || [];
            
            const detailsDiv = document.getElementById('dayDetails');
            const titleDiv = document.getElementById('selectedDayTitle');
            const medsDiv = document.getElementById('dayMedications');
            
            detailsDiv.style.display = 'block';
            
            // Format date for title
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            titleDiv.textContent = `Medications for ${date.toLocaleDateString('en-US', options)}`;
            
            if (dayMeds.length === 0) {
                medsDiv.innerHTML = `
                    <div class="empty-state">
                        <p>No medications scheduled for this day</p>
                    </div>
                `;
                return;
            }
            
            // Group medications by name+dosage (not ID) and deduplicate times
            const groupedMeds = {};
            dayMeds.forEach(med => {
                const medKey = `${med.medications.medication_name}|${med.medications.dosage}`;
                if (!groupedMeds[medKey]) {
                    groupedMeds[medKey] = {
                        name: med.medications.medication_name,
                        dosage: med.medications.dosage,
                        timesMap: {}
                    };
                }
                
                // Use time as key to avoid duplicates
                const timeKey = med.scheduled_time.slice(0, 5);
                if (!groupedMeds[medKey].timesMap[timeKey]) {
                    // First entry for this time
                    groupedMeds[medKey].timesMap[timeKey] = {
                        schedule_id: med.schedule_id,
                        time: timeKey,
                        is_taken: med.is_taken,
                        skipped: med.skipped
                    };
                } else {
                    // Duplicate time - prefer the one with status
                    const existing = groupedMeds[medKey].timesMap[timeKey];
                    if ((med.is_taken || med.skipped) && !existing.is_taken && !existing.skipped) {
                        groupedMeds[medKey].timesMap[timeKey] = {
                            schedule_id: med.schedule_id,
                            time: timeKey,
                            is_taken: med.is_taken,
                            skipped: med.skipped
                        };
                    }
                }
            });
            
            let html = '';
            Object.values(groupedMeds).forEach(med => {
                // Convert timesMap to array and sort
                const times = Object.values(med.timesMap).sort((a, b) => a.time.localeCompare(b.time));
                
                // Check if all times are taken or skipped
                const allTaken = times.every(t => t.is_taken);
                const anySkipped = times.some(t => t.skipped);
                const statusClass = allTaken ? 'taken' : anySkipped ? 'skipped' : '';
                
                // Build times display with individual checkboxes
                let timesHtml = '<div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">';
                times.forEach(timeSlot => {
                    const statusIcon = timeSlot.is_taken ? '✓' : timeSlot.skipped ? '✗' : '';
                    const statusColor = timeSlot.is_taken ? '#28a745' : timeSlot.skipped ? '#dc3545' : '#64748b';
                    const isDisabled = timeSlot.is_taken || timeSlot.skipped;
                    
                    timesHtml += `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: ${isDisabled ? '#f8fafc' : 'white'}; border-radius: 6px; border: 1px solid #e5e5e5;">
                            <span style="font-weight: 600; color: ${statusColor}; min-width: 60px;">${timeSlot.time}</span>
                            <span style="color: ${statusColor}; font-weight: 700; min-width: 20px;">${statusIcon}</span>
                            ${!isDisabled ? `
                                <button onclick="markAsTaken('${timeSlot.schedule_id}')" class="btn btn-success btn-small">Taken</button>
                                <button onclick="markAsSkipped('${timeSlot.schedule_id}')" class="btn btn-secondary btn-small">Skip</button>
                            ` : `
                                <span class="badge ${timeSlot.is_taken ? 'badge-success' : 'badge-danger'}">${timeSlot.is_taken ? 'Taken' : 'Skipped'}</span>
                            `}
                        </div>
                    `;
                });
                timesHtml += '</div>';
                
                html += `
                    <div class="medication-entry ${statusClass}">
                        <div class="medication-info" style="width: 100%;">
                            <div class="medication-name">${med.name}</div>
                            <div class="medication-dosage">${med.dosage} - ${times.length} dose${times.length > 1 ? 's' : ''} today</div>
                            ${timesHtml}
                        </div>
                    </div>
                `;
            });
            
            medsDiv.innerHTML = html;
        }

        async function markAsTaken(scheduleId) {
            try {
                const { error } = await supabase
                    .from('medication_schedule')
                    .update({
                        is_taken: true,
                        taken_at: new Date().toISOString()
                    })
                    .eq('schedule_id', scheduleId);

                if (error) throw error;

                // Reload data
                await loadMonthSchedule(currentDate.getFullYear(), currentDate.getMonth());
                renderCalendar();
                loadDayMedications(selectedDate);

            } catch (error) {
                console.error('Error marking as taken:', error);
                alert('Error marking medication as taken');
            }
        }

        async function markAsSkipped(scheduleId) {
            try {
                const { error } = await supabase
                    .from('medication_schedule')
                    .update({ skipped: true })
                    .eq('schedule_id', scheduleId);

                if (error) throw error;

                // Reload data
                await loadMonthSchedule(currentDate.getFullYear(), currentDate.getMonth());
                renderCalendar();
                loadDayMedications(selectedDate);

            } catch (error) {
                console.error('Error marking as skipped:', error);
                alert('Error marking medication as skipped');
            }
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Medication Management
        function openAddMedicationModal() {
            document.getElementById('addMedicationModal').classList.add('active');
        }

        function closeAddMedicationModal() {
            document.getElementById('addMedicationModal').classList.remove('active');
            document.getElementById('addMessage').innerHTML = '';
            document.getElementById('medicationForm').reset();
            document.getElementById('timeInputs').innerHTML = `
                <div class="time-input-group">
                    <input type="time" class="time-input" value="08:00" required>
                </div>
            `;
        }

        function addTimeInput() {
            const container = document.getElementById('timeInputs');
            const newInput = document.createElement('div');
            newInput.className = 'time-input-group';
            newInput.innerHTML = `
                <input type="time" class="time-input" required>
                <button type="button" onclick="removeTimeInput(this)">Remove</button>
            `;
            container.appendChild(newInput);
        }

        function removeTimeInput(button) {
            button.parentElement.remove();
        }

        // Auto-calculate end date from start date + duration
        document.addEventListener('DOMContentLoaded', function() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const durationInput = document.getElementById('durationDays');

            // Set default start date to today
            if (startDateInput) {
                startDateInput.value = formatDate(new Date());
            }

            // Calculate end date when duration changes
            if (durationInput && startDateInput && endDateInput) {
                durationInput.addEventListener('input', function() {
                    const duration = parseInt(this.value);
                    const startDate = startDateInput.value;
                    
                    if (duration && startDate) {
                        const start = new Date(startDate);
                        start.setDate(start.getDate() + duration);
                        endDateInput.value = formatDate(start);
                    }
                });

                // Recalculate if start date changes
                startDateInput.addEventListener('change', function() {
                    const duration = parseInt(durationInput.value);
                    
                    if (duration) {
                        const start = new Date(this.value);
                        start.setDate(start.getDate() + duration);
                        endDateInput.value = formatDate(start);
                    }
                });

                // Clear duration if end date is manually set
                endDateInput.addEventListener('input', function() {
                    if (this.value) {
                        durationInput.value = '';
                    }
                });
            }
        });

        async function addMedication(event) {
            event.preventDefault();
            
            const submitButton = event.target.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'Adding...';
            
            const medicationName = document.getElementById('medicationName').value;
            const dosage = document.getElementById('dosage').value;
            const frequency = document.getElementById('frequency').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const durationDays = document.getElementById('durationDays').value;
            const prescribingDoctor = document.getElementById('prescribingDoctor').value || null;
            const pharmacyName = document.getElementById('pharmacyName').value || null;
            const notes = document.getElementById('notes').value || null;
            
            // Calculate actual end date
            let actualEndDate = null;
            if (endDate) {
                actualEndDate = endDate;
            } else if (durationDays) {
                const start = new Date(startDate);
                start.setDate(start.getDate() + parseInt(durationDays));
                actualEndDate = formatDate(start);
            }
            
            const timeInputs = document.querySelectorAll('.time-input');
            const times = Array.from(timeInputs).map(input => input.value);
            
            if (times.length === 0) {
                alert('Please add at least one time of day');
                submitButton.disabled = false;
                submitButton.textContent = originalText;
                return;
            }

            if (!startDate) {
                alert('Please select a start date');
                submitButton.disabled = false;
                submitButton.textContent = originalText;
                return;
            }

            try {
                // Check for duplicate
                const { data: existing } = await supabase
                    .from('medications')
                    .select('medication_id')
                    .eq('user_id', currentUser.id)
                    .eq('medication_name', medicationName)
                    .eq('dosage', dosage)
                    .eq('is_active', true)
                    .maybeSingle();

                if (existing) {
                    alert('This medication already exists in your active medications.');
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                    return;
                }

                // Insert medication
                const { data: medication, error } = await supabase
                    .from('medications')
                    .insert([{
                        user_id: currentUser.id,
                        medication_name: medicationName,
                        dosage: dosage,
                        frequency: frequency,
                        time_of_day: times,
                        start_date: startDate,
                        end_date: actualEndDate,
                        refill_date: actualEndDate, // For backward compatibility
                        prescribing_doctor: prescribingDoctor,
                        pharmacy_name: pharmacyName,
                        notes: notes
                    }])
                    .select()
                    .single();

                if (error) throw error;

                // Calculate number of days to generate schedule
                const start = new Date(startDate);
                const end = actualEndDate ? new Date(actualEndDate) : new Date(start.getTime() + 90 * 24 * 60 * 60 * 1000); // Default 90 days if no end date
                const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                const daysToGenerate = Math.min(daysDiff + 1, 365); // Max 1 year

                // Generate schedule with custom start date and duration
                await supabase.rpc('generate_medication_schedule', {
                    med_id: medication.medication_id,
                    u_id: currentUser.id,
                    times: times,
                    start_date: startDate,
                    days_ahead: daysToGenerate
                });

                alert('Medication added successfully!');
                closeAddMedicationModal();
                await loadMedications();
                await loadMonthSchedule(currentDate.getFullYear(), currentDate.getMonth());
                renderCalendar();
                loadDayMedications(selectedDate);

            } catch (error) {
                console.error('Error adding medication:', error);
                alert('Error adding medication: ' + error.message);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        }

        async function loadMedications() {
            try {
                const { data, error } = await supabase
                    .from('medications')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('is_active', { ascending: false })
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('medicationsList');
                
                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No Medications Yet</h3>
                            <p>Add your first medication to get started</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                data.forEach(med => {
                    const times = med.time_of_day ? med.time_of_day.join(', ') : 'Not specified';
                    const startDate = med.start_date ? new Date(med.start_date).toLocaleDateString() : 'Not set';
                    const endDate = med.end_date ? new Date(med.end_date).toLocaleDateString() : 'Ongoing';
                    
                    html += `
                        <div class="medication-item ${!med.is_active ? 'inactive' : ''}">
                            <div class="medication-header">
                                <div>
                                    <div class="medication-header-name">${med.medication_name}</div>
                                    <div class="medication-header-dosage">${med.dosage} - ${med.frequency}</div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button onclick="toggleMedicationActive('${med.medication_id}', ${!med.is_active})" class="btn btn-secondary btn-small">
                                        ${med.is_active ? 'Deactivate' : 'Activate'}
                                    </button>
                                    <button onclick="deleteMedication('${med.medication_id}', '${med.medication_name}')" class="btn btn-danger btn-small">Delete</button>
                                </div>
                            </div>
                            <div class="medication-details">
                                <div class="medication-detail">
                                    <span class="detail-label">Start Date</span>
                                    <span class="detail-value">${startDate}</span>
                                </div>
                                <div class="medication-detail">
                                    <span class="detail-label">End Date</span>
                                    <span class="detail-value">${endDate}</span>
                                </div>
                                <div class="medication-detail">
                                    <span class="detail-label">Times</span>
                                    <span class="detail-value">${times}</span>
                                </div>
                                ${med.prescribing_doctor ? `
                                <div class="medication-detail">
                                    <span class="detail-label">Doctor</span>
                                    <span class="detail-value">${med.prescribing_doctor}</span>
                                </div>
                                ` : ''}
                                ${med.pharmacy_name ? `
                                <div class="medication-detail">
                                    <span class="detail-label">Pharmacy</span>
                                    <span class="detail-value">${med.pharmacy_name}</span>
                                </div>
                                ` : ''}
                            </div>
                            ${med.notes ? `<div style="margin-top: 10px; color: #64748b; font-size: 13px;">${med.notes}</div>` : ''}
                        </div>
                    `;
                });

                container.innerHTML = html;

            } catch (error) {
                console.error('Error loading medications:', error);
                document.getElementById('medicationsList').innerHTML = `
                    <div class="message error">Error loading medications</div>
                `;
            }
        }

        async function toggleMedicationActive(medicationId, newStatus) {
            try {
                const { error } = await supabase
                    .from('medications')
                    .update({ is_active: newStatus })
                    .eq('medication_id', medicationId);

                if (error) throw error;

                await loadMedications();
                await loadMonthSchedule(currentDate.getFullYear(), currentDate.getMonth());
                renderCalendar();
                loadDayMedications(selectedDate);

            } catch (error) {
                console.error('Error toggling medication:', error);
                alert('Error updating medication status');
            }
        }

        async function deleteMedication(medicationId, medicationName) {
            if (!confirm(`Are you sure you want to delete ${medicationName}? This will remove all associated schedules.`)) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('medications')
                    .delete()
                    .eq('medication_id', medicationId);

                if (error) throw error;

                alert('Medication deleted successfully');
                await loadMedications();
                await loadMonthSchedule(currentDate.getFullYear(), currentDate.getMonth());
                renderCalendar();
                loadDayMedications(selectedDate);

            } catch (error) {
                console.error('Error deleting medication:', error);
                alert('Error deleting medication: ' + error.message);
            }
        }
    </script>
</body>
</html>