<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"> 
    <title>Healthub Connect Document Saver</title>
    <link rel="stylesheet" href="index_styles.css">
    <style>
        section {
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        .upload-area {
            background: #f9f9f9;
            padding: 30px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px dashed #4b3fa6;
        }
        .upload-area label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        .upload-area select,
        .upload-area input[type="file"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #aaa;
            box-sizing: border-box;
        }
        .upload-area button {
            margin-top: 10px;
            background: #4b3fa6;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }
        .upload-area button:hover {
            background: #3a2f88;
        }
        .upload-area button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .document-list {
            margin-top: 30px;
        }
        .document-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #4b3fa6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .document-info {
            flex: 1;
        }
        .document-info strong {
            display: block;
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
        }
        .document-info p {
            margin: 3px 0;
            font-size: 14px;
            color: #666;
        }
        .document-actions {
            display: flex;
            gap: 10px;
        }
        .document-actions button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        .btn-view {
            background: #4b3fa6;
            color: white;
        }
        .btn-view:hover {
            background: #3a2f88;
        }
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        .btn-delete:hover {
            background: #c82333;
        }
        .login-prompt {
            text-align: center;
            padding: 40px;
        }
        .message {
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            text-align: center;
        }
        .message.success {
            background: #e6ffe6;
            border: 1px solid #9bff9b;
            color: #060;
        }
        .message.error {
            background: #ffe6e6;
            border: 1px solid #ff9b9b;
            color: #c00;
        }
        .file-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .upload-progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
            display: none;
        }
        .upload-progress-bar {
            height: 100%;
            background: #4b3fa6;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="Title">
        <h1>Healthub Connect Document Saver</h1>
        <div id="userInfo" style="margin:0; text-align: center;"></div>
    </div>
    
    <div class="top-bar">
        <button class="signin-btn" id="authButton" onclick="handleAuth()">Sign In</button>
    </div>
    
    <hr>
    
    <h2 class="Navigations">
        <a href="index.html">Home</a>
        <a href="documents.html">Documents</a>
        <a href="tracker.html">Trackers</a>
        <a href="assistant.html">AI Health Assistant</a>
        <a href="appointments.html">Appointments</a>
        <a href="insurance.html">Insurance Hub</a>
        <a href="summaries.html">Visit Summaries</a>
        <a href="family.html">Family Access</a>
        <a href="payments.html">Payments</a>
        <a href="support.html">Support Call Center</a>
        <a href="links.html">Helpful Links</a>
        <a href="about.html">About</a>
    </h2>
    
    <hr>
    
    <section>
        <div id="content">
            <!-- Content will be loaded based on auth status -->
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        // ============================================
        // CONFIGURATION - CHANGE THIS IF NEEDED
        // ============================================
        const STORAGE_BUCKET_NAME = 'health-documents';  // ‚Üê Matches your code!
        
        // Initialize Supabase
        const supabaseUrl = 'https://hbtgwzneuhdqlmriwvje.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhidGd3em5ldWhkcWxtcml3dmplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNDI5MTQsImV4cCI6MjA3NTkxODkxNH0.1v1OLYSEPRBKaZWQu1sJo8DoRzYePfdc7Zcs8i8TF78';
        
        let supabase;
        let currentUserId = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Check if Supabase library is loaded
            if (typeof window.supabase === 'undefined') {
                console.error('‚ùå Supabase library not loaded!');
                document.getElementById('content').innerHTML = '<div style="text-align:center; padding:40px;"><p style="color:red;">Error: Supabase library failed to load. Please refresh the page.</p></div>';
                return;
            }
            
            // Initialize Supabase
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            console.log('‚úÖ Supabase initialized');
            
            // Wait a moment to ensure Supabase is fully ready
            setTimeout(checkAuth, 100);
        });

        async function checkAuth() {
            if (!supabase) {
                console.error('‚ùå Supabase not initialized');
                return;
            }
            
            const { data: { session } } = await supabase.auth.getSession();
            const authButton = document.getElementById('authButton');
            const userInfo = document.getElementById('userInfo');
            const content = document.getElementById('content');

            if (session) {
                // User is signed in
                currentUserId = session.user.id;
                console.log('User is authenticated:', currentUserId);
                
                // Get user info from profiles
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('first_name, last_name')
                    .eq('user_id', currentUserId)
                    .single();

                const firstName = profile?.first_name || session.user.email;
                userInfo.innerHTML = `Hello, ${firstName} ‚Äî <a href="#" onclick="signOut(); return false;">Sign Out</a>`;
                authButton.style.display = 'none';
                
                // Load documents content
                content.innerHTML = `
                    <h2>Your Health Documents</h2>
                    <p>Upload, view, and manage your health documents securely.</p>
                    
                    <div id="messageDiv"></div>
                    
                    <div class="upload-area">
                        <h3>Upload New Document</h3>
                        <form id="uploadForm">
                            <label>Document Type *</label>
                            <select id="document_type" name="document_type" required>
                                <option value="">-- Select Type --</option>
                                <option value="prescription">Prescription</option>
                                <option value="lab_report">Lab Report</option>
                                <option value="imaging">Imaging (X-Ray, MRI, etc.)</option>
                                <option value="other">Other</option>
                            </select>
                            
                            <label>Select File *</label>
                            <input type="file" id="document_file" name="document_file" 
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" required>
                            <div class="file-info">Accepted formats: PDF, JPG, PNG, DOC, DOCX (Max 10MB)</div>
                            
                            <div class="upload-progress" id="uploadProgress">
                                <div class="upload-progress-bar" id="uploadProgressBar">0%</div>
                            </div>
                            
                            <button type="submit" id="uploadBtn">Upload Document</button>
                        </form>
                    </div>
                    
                    <div class="document-list">
                        <h3>Your Documents</h3>
                        <div id="documentsList">
                            <p>Loading documents...</p>
                        </div>
                    </div>
                `;
                
                // Add form submit handler
                document.getElementById('uploadForm').addEventListener('submit', handleUpload);
                
                // Add file input change handler to show file info
                document.getElementById('document_file').addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                        if (file.size > 10 * 1024 * 1024) {
                            showMessage('File is too large! Maximum size is 10MB.', 'error');
                            e.target.value = '';
                        }
                    }
                });
                
                // Load existing documents
                loadDocuments(currentUserId);
            } else {
                // User is signed out
                console.log('User is not authenticated');
                currentUserId = null;
                userInfo.innerHTML = '';
                authButton.style.display = 'block';
                authButton.textContent = 'Sign In';
                
                content.innerHTML = `
                    <div class="login-prompt">
                        <h3>Please Sign In to Access Documents</h3>
                        <p>You need to be logged in to view and upload health documents.</p>
                        <button onclick="handleAuth()" class="signin-btn">Sign In</button>
                    </div>
                `;
            }
        }

        async function handleUpload(e) {
            e.preventDefault();
            
            if (!supabase) {
                showMessage('‚ùå System not ready. Please refresh the page.', 'error');
                return;
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            const documentType = document.getElementById('document_type').value;
            const fileInput = document.getElementById('document_file');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('Please select a file to upload.', 'error');
                return;
            }
            
            if (!documentType) {
                showMessage('Please select a document type.', 'error');
                return;
            }
            
            // Validate file size
            if (file.size > 10 * 1024 * 1024) {
                showMessage('File is too large! Maximum size is 10MB.', 'error');
                return;
            }
            
            // Show loading state
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            document.getElementById('uploadProgress').style.display = 'block';
            
            try {
                console.log('üöÄ Starting file upload...');
                
                // Create unique file path: userId/timestamp_filename
                const timestamp = Date.now();
                const fileExt = file.name.split('.').pop();
                const fileName = file.name.replace(`.${fileExt}`, '');
                const sanitizedFileName = fileName.replace(/[^a-zA-Z0-9]/g, '_');
                const filePath = `${currentUserId}/${timestamp}_${sanitizedFileName}.${fileExt}`;
                
                console.log('Uploading to:', filePath);
                
                // Upload file to Supabase Storage
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from(STORAGE_BUCKET_NAME)
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (uploadError) {
                    throw new Error(`Upload failed: ${uploadError.message}`);
                }
                
                console.log('‚úÖ File uploaded to storage:', uploadData);
                
                // Update progress
                document.getElementById('uploadProgressBar').style.width = '80%';
                document.getElementById('uploadProgressBar').textContent = '80%';
                
                // Save metadata to database
                const { data: dbData, error: dbError } = await supabase
                    .from('documents')
                    .insert([{
                        user_id: currentUserId,
                        document_type: documentType,
                        file_path: filePath,
                        file_name: file.name,
                        file_size: file.size
                    }])
                    .select();
                
                if (dbError) {
                    // If database insert fails, try to delete the uploaded file
                    await supabase.storage.from(STORAGE_BUCKET_NAME).remove([filePath]);
                    throw new Error(`Database error: ${dbError.message}`);
                }
                
                console.log('‚úÖ Metadata saved to database:', dbData);
                
                // Update progress to 100%
                document.getElementById('uploadProgressBar').style.width = '100%';
                document.getElementById('uploadProgressBar').textContent = '100%';
                
                showMessage('‚úÖ Document uploaded successfully!', 'success');
                
                // Reset form
                document.getElementById('uploadForm').reset();
                
                // Hide progress bar after a moment
                setTimeout(() => {
                    document.getElementById('uploadProgress').style.display = 'none';
                    document.getElementById('uploadProgressBar').style.width = '0%';
                }, 2000);
                
                // Reload documents list
                loadDocuments(currentUserId);
                
            } catch (error) {
                console.error('‚ùå Upload error:', error);
                showMessage('‚ùå ' + error.message, 'error');
                document.getElementById('uploadProgress').style.display = 'none';
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload Document';
            }
        }

        async function loadDocuments(userId) {
            if (!supabase) {
                console.error('‚ùå Supabase not initialized');
                return;
            }
            
            try {
                console.log('üìÑ Loading documents for user:', userId);
                
                const { data: documents, error } = await supabase
                    .from('documents')
                    .select('*')
                    .eq('user_id', userId)
                    .order('uploaded_at', { ascending: false });

                if (error) {
                    console.error('Database error:', error);
                    throw error;
                }
                
                console.log('‚úÖ Found', documents?.length || 0, 'documents');

                const docsList = document.getElementById('documentsList');
                
                if (!documents || documents.length === 0) {
                    docsList.innerHTML = '<p>No documents uploaded yet. Upload your first document above!</p>';
                } else {
                    docsList.innerHTML = documents.map(doc => {
                        const sizeMB = (doc.file_size / (1024 * 1024)).toFixed(2);
                        const uploadDate = new Date(doc.uploaded_at).toLocaleString();
                        const typeLabel = {
                            'prescription': 'üíä Prescription',
                            'lab_report': 'üß™ Lab Report',
                            'imaging': 'üî¨ Imaging',
                            'other': 'üìÑ Other'
                        }[doc.document_type] || 'üìÑ Document';
                        
                        console.log('Document file path:', doc.file_path);
                        
                        return `
                            <div class="document-item">
                                <div class="document-info">
                                    <strong>${typeLabel}: ${doc.file_name}</strong>
                                    <p>Size: ${sizeMB} MB | Uploaded: ${uploadDate}</p>
                                </div>
                                <div class="document-actions">
                                    <button class="btn-view" onclick="viewDocument('${doc.file_path}', '${doc.file_name}')">
                                        üëÅÔ∏è View
                                    </button>
                                    <button class="btn-delete" onclick="deleteDocument('${doc.document_id}', '${doc.file_path}')">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading documents:', error);
                document.getElementById('documentsList').innerHTML = '<p>Error loading documents.</p>';
            }
        }

        async function viewDocument(filePath, fileName) {
            if (!supabase) {
                showMessage('‚ùå System not ready. Please refresh the page.', 'error');
                return;
            }
            
            try {
                console.log('Viewing document:', filePath);
                console.log('Using bucket:', STORAGE_BUCKET_NAME);
                
                // For private buckets, we need to download the file
                // Public URLs won't work for private buckets
                const { data: downloadData, error } = await supabase.storage
                    .from(STORAGE_BUCKET_NAME)
                    .download(filePath);
                
                if (error) {
                    console.error('Download error:', error);
                    throw error;
                }
                
                console.log('‚úÖ File downloaded successfully');
                
                // Create a blob URL and open/download it
                const blob = new Blob([downloadData], { type: downloadData.type });
                const url = URL.createObjectURL(blob);
                
                // Check file type
                const fileExt = fileName.split('.').pop().toLowerCase();
                const isPDF = fileExt === 'pdf';
                const isImage = ['jpg', 'jpeg', 'png', 'gif'].includes(fileExt);
                
                if (isPDF || isImage) {
                    // Open in new tab for PDFs and images
                    window.open(url, '_blank');
                } else {
                    // Download for other file types
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }
                
                // Clean up the blob URL after a delay
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
            } catch (error) {
                console.error('Error viewing document:', error);
                showMessage('‚ùå Error opening document: ' + error.message, 'error');
            }
        }

        async function deleteDocument(documentId, filePath) {
            if (!supabase) {
                showMessage('‚ùå System not ready. Please refresh the page.', 'error');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
                return;
            }
            
            try {
                console.log('Deleting document:', documentId, filePath);
                console.log('Using bucket:', STORAGE_BUCKET_NAME);
                
                // Delete from storage
                const { error: storageError } = await supabase.storage
                    .from(STORAGE_BUCKET_NAME)
                    .remove([filePath]);
                
                if (storageError) {
                    console.warn('Storage delete warning:', storageError);
                    // Continue anyway - file might not exist
                }
                
                // Delete from database
                const { error: dbError } = await supabase
                    .from('documents')
                    .delete()
                    .eq('document_id', documentId);
                
                if (dbError) throw dbError;
                
                showMessage('‚úÖ Document deleted successfully!', 'success');
                
                // Reload documents list
                loadDocuments(currentUserId);
                
            } catch (error) {
                console.error('Error deleting document:', error);
                showMessage('‚ùå Error deleting document: ' + error.message, 'error');
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('messageDiv');
            messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            // Clear message after 5 seconds
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }

        function handleAuth() {
            window.location.href = 'signin.html';
        }

        async function signOut() {
            if (!supabase) return;
            await supabase.auth.signOut();
            window.location.reload();
        }

        // Listen for auth state changes
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for supabase to be initialized before setting up listener
            setTimeout(function() {
                if (supabase) {
                    supabase.auth.onAuthStateChange((event, session) => {
                        console.log('Auth state changed:', event);
                        if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
                            checkAuth();
                        }
                    });
                }
            }, 200);
        });
    </script>
</body>
</html>