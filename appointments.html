<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Appointment - HealthHub Connect</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8fafc;
        }

        /* Header */
        .header {
            background: #00d4d4;
            color: #1e293b;
            padding: 1.5rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-section img {
            height: 50px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .user-greeting {
            font-weight: 600;
            color: #1e293b;
        }

        /* Navigation */
        .nav-section {
            background: white;
            padding: 20px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .nav-pills {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .nav-pills a {
            padding: 10px 20px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: 600;
            color: #5b21b6;
            background: #f1f5f9;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .nav-pills a:hover, .nav-pills a.active {
            background: #5b21b6;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(91, 33, 182, 0.3);
        }

        /* Buttons */
        .btn {
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
        }

        .btn-primary {
            background: #5b21b6;
            color: white;
        }

        .btn-primary:hover {
            background: #4c1d95;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(91, 33, 182, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: #1e293b;
            border: 2px solid #1e293b;
        }

        .btn-secondary:hover {
            background: #1e293b;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        /* Page Header */
        .page-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .page-header h1 {
            color: #1e293b;
            margin-bottom: 10px;
            font-size: 32px;
            font-weight: 700;
        }

        .page-header p {
            color: #64748b;
            font-size: 16px;
        }

        /* Cards */
        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .card h2 {
            color: #5b21b6;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 700;
        }

        /* Form Styles */
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1e293b;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            margin-bottom: 20px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #5b21b6;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Appointment Cards */
        .appointment-item {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #5b21b6;
        }

        .appointment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .appointment-title {
            font-weight: 700;
            font-size: 18px;
            color: #1e293b;
        }

        .appointment-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            color: #64748b;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .detail-value {
            color: #1e293b;
            font-weight: 600;
            margin-top: 4px;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }

        .badge-confirmed {
            background: #d4edda;
            color: #155724;
        }

        .badge-declined {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-cancelled {
            background: #e2e8f0;
            color: #475569;
        }

        .badge-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Time Slots */
        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .time-slot {
            padding: 12px;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .time-slot:hover {
            border-color: #5b21b6;
            background: #f8f5ff;
        }

        .time-slot.selected {
            background: #5b21b6;
            border-color: #5b21b6;
            color: white;
        }

        .time-slot.unavailable {
            opacity: 0.4;
            cursor: not-allowed;
            background: #f1f5f9;
        }

        .time-slot.unavailable:hover {
            border-color: #e5e5e5;
            background: #f1f5f9;
        }

        /* Message */
        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #90caf9;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-state h3 {
            color: #1e293b;
            margin-bottom: 10px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 20px;
            color: #64748b;
        }

        /* Footer */
        .footer {
            background: #1e293b;
            color: white;
            text-align: center;
            padding: 30px 20px;
            margin-top: 60px;
        }

        .footer p {
            margin: 5px 0;
            font-size: 14px;
        }

        /* Doctor Card */
        .doctor-card {
            background: white;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .doctor-card:hover {
            border-color: #5b21b6;
            box-shadow: 0 4px 12px rgba(91, 33, 182, 0.2);
        }

        .doctor-card.selected {
            border-color: #5b21b6;
            background: #f8f5ff;
        }

        .doctor-name {
            font-weight: 700;
            font-size: 18px;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .doctor-specialty {
            color: #5b21b6;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .doctor-info {
            color: #64748b;
            font-size: 13px;
        }
    
    /* Chat Bubble */
    .chat-bubble-trigger {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: #5b21b6;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(91, 33, 182, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: transform 0.3s ease;
    }

    .chat-bubble-trigger:hover {
      transform: scale(1.1);
    }

    .chat-bubble-trigger.show {
      display: flex;
    }

    .chat-bubble-trigger svg {
      width: 30px;
      height: 30px;
      fill: white;
    }

    .chat-bubble-trigger.open {
      display: none;
    }

    .chat-window {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 380px;
      height: 550px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      display: none;
      flex-direction: column;
      z-index: 1001;
      overflow: hidden;
    }

    .chat-window.open {
      display: flex;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .chat-header {
      background: #5b21b6;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .chat-close {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .chat-close:hover {
      background: rgba(255,255,255,0.2);
    }

    .chat-body {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #f8fafc;
    }

    .chat-footer {
      display: flex;
      gap: 10px;
      padding: 15px;
      border-top: 1px solid #e2e8f0;
      background: white;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 24px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.3s;
    }

    .chat-input:focus {
      border-color: #5b21b6;
    }

    .chat-send-btn {
      background: #5b21b6;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 24px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: opacity 0.2s;
    }

    .chat-send-btn:hover {
      opacity: 0.9;
    }

    .chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .msg {
      display: flex;
      margin: 15px 0;
      max-width: 85%;
    }

    .msg.user {
      margin-left: auto;
      justify-content: flex-end;
    }

    .msg.ai {
      margin-right: auto;
      justify-content: flex-start;
    }

    .bubble {
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .bubble.user {
      background: #f1f5f9;
      color: #1e293b;
      border-bottom-right-radius: 4px;
    }

    .bubble.ai {
      background: #5b21b6;
      color: white;
      border-bottom-left-radius: 4px;
    }

    @media (max-width: 768px) {
      .chat-window {
        width: calc(100% - 40px);
        height: calc(100% - 100px);
      }
    }
  
    /* Reminder Bot */
    .reminder-bot {
      position: fixed;
      top: 100px;
      left: 30px;
      width: 320px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(91, 33, 182, 0.2);
      border: 2px solid #5b21b6;
      padding: 20px;
      z-index: 999;
      animation: slideInLeft 0.5s ease;
    }

    @keyframes slideInLeft {
      from {
        transform: translateX(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .reminder-bot-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f1f5f9;
    }

    .reminder-bot-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #5b21b6 0%, #7c3aed 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(91, 33, 182, 0.4);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 0 0 10px rgba(91, 33, 182, 0);
      }
    }

    .reminder-bot-title {
      flex: 1;
    }

    .reminder-bot-title h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: #5b21b6;
    }

    .reminder-bot-title p {
      margin: 2px 0 0 0;
      font-size: 12px;
      color: #64748b;
    }

    .reminder-bot-close {
      background: none;
      border: none;
      color: #64748b;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .reminder-bot-close:hover {
      background: #f1f5f9;
      color: #5b21b6;
    }

    .reminder-bot-content {
      color: #1e293b;
      line-height: 1.6;
    }

    .reminder-item {
      background: #f8fafc;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #5b21b6;
    }

    .reminder-item:last-child {
      margin-bottom: 0;
    }

    .reminder-item-title {
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 4px;
      font-size: 15px;
    }

    .reminder-item-detail {
      font-size: 14px;
      color: #64748b;
      margin: 3px 0;
    }

    .reminder-item-time {
      font-size: 13px;
      color: #5b21b6;
      font-weight: 600;
      margin-top: 6px;
    }

    .no-reminders {
      text-align: center;
      padding: 20px;
      color: #64748b;
      font-size: 14px;
    }

    .no-reminders-icon {
      font-size: 48px;
      margin-bottom: 10px;
      opacity: 0.3;
    }

    @media (max-width: 768px) {
      .reminder-bot {
        left: 10px;
        right: 10px;
        width: auto;
        top: 80px;
      }
    }
  </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <img src="healthhub-logo.svg" alt="HealthHub Connect Logo">
                <div class="logo-text">HealthHub Connect</div>
            </div>
            <div class="user-info">
                <span class="user-greeting" id="userGreeting"></span>
                <button id="authButton" class="btn btn-secondary">Sign In</button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav-section">
        <div class="nav-pills">
            <a href="index.html">Home</a>
            <a href="documents.html">Documents</a>
            <a href="tracker.html">Health Tracker</a>
            <a href="appointments.html">Appointments</a>
            <a href="medications.html">Medications</a>
            <a href="profile.html">Profile</a>
            <a href="family_dashboard.html">Family Dashboard</a>
            <a href="support.html">Support</a>
            <a href="helpfullink.html">Helpful Links</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>Book an Appointment</h1>
            <p>Schedule a visit with your healthcare provider</p>
        </div>

        <!-- Book Appointment Section -->
        <div class="card">
            <h2>New Appointment</h2>
            <div id="bookingMessage"></div>
            
            <form id="appointmentForm" onsubmit="bookAppointment(event)">
                <!-- Step 1: Select Hospital -->
                <div class="form-step" id="step1">
                    <h3 style="color: #1e293b; margin-bottom: 15px;">Step 1: Select Location</h3>
                    
                    <label>Hospital/Facility *</label>
                    <select id="hospitalSelect" required onchange="loadDoctorsForHospital()">
                        <option value="">Select hospital or clinic...</option>
                    </select>
                </div>

                <!-- Step 2: Select Doctor -->
                <div class="form-step" id="step2" style="display: none;">
                    <h3 style="color: #1e293b; margin: 20px 0 15px 0;">Step 2: Select Doctor</h3>
                    
                    <label>Filter by Specialization</label>
                    <select id="specializationFilter" onchange="filterDoctors()">
                        <option value="">All Specializations</option>
                    </select>

                    <div id="doctorsList" style="margin-top: 20px;">
                        <div class="loading">Select a hospital first...</div>
                    </div>
                </div>

                <!-- Step 3: Appointment Details -->
                <div class="form-step" id="step3" style="display: none;">
                    <h3 style="color: #1e293b; margin: 20px 0 15px 0;">Step 3: Appointment Details</h3>
                    
                    <div class="form-row">
                        <div>
                            <label>Appointment Type *</label>
                            <select id="appointmentType" required>
                                <option value="">Select type...</option>
                                <option value="Checkup">Routine Checkup</option>
                                <option value="Follow-up">Follow-up Visit</option>
                                <option value="Consultation">Consultation</option>
                                <option value="Urgent">Urgent Care</option>
                                <option value="Screening">Health Screening</option>
                                <option value="Vaccination">Vaccination</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label>Is this your first visit with this doctor? *</label>
                            <select id="firstVisit" required>
                                <option value="false">No, I've seen this doctor before</option>
                                <option value="true">Yes, this is my first visit</option>
                            </select>
                        </div>
                    </div>

                    <label>Reason for Visit *</label>
                    <textarea id="visitReason" rows="3" placeholder="Please describe why you need to see the doctor..." required></textarea>

                    <label>Current Symptoms (if any)</label>
                    <textarea id="symptoms" rows="3" placeholder="Describe any symptoms you're experiencing..."></textarea>

                    <div class="form-row">
                        <div>
                            <label>Preferred Date *</label>
                            <input type="date" id="appointmentDate" required onchange="loadAvailableSlots()">
                        </div>
                        <div>
                            <label>Insurance Card (optional)</label>
                            <select id="insuranceSelect">
                                <option value="">No insurance / Pay out of pocket</option>
                            </select>
                        </div>
                    </div>

                    <div id="timeSlotsSection" style="display: none;">
                        <label>Select Time Slot *</label>
                        <div id="timeSlotsList" class="time-slots-grid">
                            <div class="loading">Select a date first...</div>
                        </div>
                    </div>

                    <label>Additional Notes</label>
                    <textarea id="patientNotes" rows="2" placeholder="Any additional information the doctor should know..."></textarea>

                    <div class="message info" style="margin-top: 20px;">
                        <strong>üìã Note:</strong> Your appointment is pending until confirmed by the doctor. You'll receive a notification once it's confirmed.
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn btn-success" style="flex: 1;">Book Appointment</button>
                        <button type="button" onclick="resetForm()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- My Appointments Section -->
        <div class="card">
            <h2>My Appointments</h2>
            <div id="appointmentsList">
                <div class="loading">Loading appointments...</div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p><strong>HealthHub Connect</strong></p>
        <p>Your health, your data, your peace of mind</p>
        <p>&copy; 2025 HealthHub Connect. All rights reserved.</p>
    </footer>

    
  
  <!-- Reminder Bot -->
  <div id="reminderBot" class="reminder-bot" style="display: none;">
    <div class="reminder-bot-header">
      <div class="reminder-bot-icon">üìÖ</div>
      <div class="reminder-bot-title">
        <h3>Upcoming Appointment</h3>
        <p>Your next visit</p>
      </div>
      <button class="reminder-bot-close" onclick="closeReminderBot()">√ó</button>
    </div>
    <div id="reminderContent" class="reminder-bot-content">
      <div class="no-reminders">
        <div class="no-reminders-icon">üìÖ</div>
        <p>Loading your appointments...</p>
      </div>
    </div>
  </div>

  <!-- Chat Bubble (only shown when logged in) -->
  <div id="chatBubbleTrigger" class="chat-bubble-trigger" onclick="openChat()">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
      <path d="M7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/>
    </svg>
  </div>

  <!-- Chat Window -->
  <div id="chatWindow" class="chat-window">
    <div class="chat-header">
      <h3>AI Health Assistant</h3>
      <button class="chat-close" onclick="closeChat()">√ó</button>
    </div>
    <div id="chatBody" class="chat-body"></div>
    <div class="chat-footer">
      <input id="chatInput" class="chat-input" placeholder="Ask a health question..." onkeypress="if(event.key==='Enter') handleSend()">
      <button id="chatSendBtn" class="chat-send-btn" onclick="handleSend()">Send</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        const supabaseUrl = 'https://hbtgwzneuhdqlmriwvje.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhidGd3em5ldWhkcWxtcml3dmplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNDI5MTQsImV4cCI6MjA3NTkxODkxNH0.1v1OLYSEPRBKaZWQu1sJo8DoRzYePfdc7Zcs8i8TF78';

        const AI_FUNCTION_URL = 'https://hbtgwzneuhdqlmriwvje.supabase.co/functions/v1/ai-chat-index-ts';
        
        let convo = [];
        let isLoggedIn = false;

        function initializeChat() {
            convo = [{
                role: "system",
                content: "You are a professional medical assistant. Keep answers short, factual, direct, and medically accurate. You only answer medical-related questions. If a question is not medical, respond with: 'Sorry, I can only answer medical-related questions.' If a request is unsafe (self-harm, drugs, medical prescriptions, or illegal topics), respond with: 'I can't help with that. Please contact a licensed medical professional or emergency services if needed.' Never break character. Do not provide emotional therapy."
            }];
        }

        function openChat() {
            if (!isLoggedIn) return;
            
            const chatWindow = document.getElementById('chatWindow');
            const chatBubble = document.getElementById('chatBubbleTrigger');
            
            chatWindow.classList.add('open');
            chatBubble.classList.add('open');
            
            const chatBody = document.getElementById('chatBody');
            if (chatBody.children.length === 0) {
                addMessage('ai', "Hello! I'm your AI Health Assistant. I can help answer health questions and provide medical information. How may I assist you?");
            }
            
            document.getElementById('chatInput').focus();
        }

        function closeChat() {
            const chatWindow = document.getElementById('chatWindow');
            const chatBubble = document.getElementById('chatBubbleTrigger');
            
            chatWindow.classList.remove('open');
            chatBubble.classList.remove('open');
        }

        function addMessage(role, text) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerHTML = `<div class="bubble ${role}">${text}</div>`;
            const chatBody = document.getElementById('chatBody');
            chatBody.appendChild(div);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        async function handleSend() {
            if (!isLoggedIn) {
                alert('Please sign in to use the AI assistant');
                return;
            }
            
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            addMessage('user', text);
            convo.push({ role: 'user', content: text });
            input.value = '';

            const sendBtn = document.getElementById('chatSendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Thinking...';

            await callAI();
            
            sendBtn.disabled = false;
            sendBtn.textContent = 'Send';
        }

        async function callAI() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                addMessage('ai', "You are signed out. Please sign in again.");
                return;
            }


        // Reminder Bot Functions







            const messages = [...convo];

            try {
                const res = await fetch(AI_FUNCTION_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({ messages })
                });

                const json = await res.json();
                const reply = json.reply || "No response.";
                addMessage('ai', reply);
                convo.push({ role: 'assistant', content: reply });

            } catch (err) {
                console.error(err);
                addMessage('ai', "I had an issue processing your request. Try again.");
            }
        }

        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        let currentUser = null;
        let selectedHospital = null;
        let selectedDoctor = null;
        let selectedTimeSlot = null;
        let allDoctors = [];
        let specializations = new Set();

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuth();
            setMinDate();
        });


        function closeReminderBot() {
            document.getElementById('reminderBot').style.display = 'none';
        }

        function showReminderBot() {
            // Always show the reminder bot
            console.log('Showing reminder bot');
            const bot = document.getElementById('reminderBot');
            if (bot) {
                bot.style.display = 'block';
                console.log('Reminder bot displayed');
            } else {
                console.error('Reminder bot element not found!');
            }
        }

        async function loadAppointmentReminder() {
            console.log('Loading appointment reminder...');
            if (!currentUser) {
                console.log('No current user, returning');
                return;
            }
            console.log('Current user:', currentUser.id);
            
            try {
                const today = new Date().toISOString().split('T')[0];
                
                const { data: appointments, error } = await supabase
                    .from('appointments')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .gte('appointment_date', today)
                    .in('status', ['pending', 'confirmed'])
                    .order('appointment_date', { ascending: true })
                    .limit(1);

                if (error) throw error;

                const reminderContent = document.getElementById('reminderContent');
                
                if (!appointments || appointments.length === 0) {
                    console.log('No upcoming appointments found');
                    reminderContent.innerHTML = `
                        <div class="no-reminders">
                            <div class="no-reminders-icon">üìÖ</div>
                            <p>No upcoming appointments</p>
                        </div>`;
                    showReminderBot();
                    return;
                }

                const apt = appointments[0];
                const aptDate = new Date(apt.appointment_date + 'T' + (apt.appointment_time || '00:00'));
                const now = new Date();
                const daysUntil = Math.ceil((aptDate - now) / (1000 * 60 * 60 * 24));
                
                let timeText = '';
                if (daysUntil === 0) {
                    timeText = 'üî¥ Today!';
                } else if (daysUntil === 1) {
                    timeText = 'üü° Tomorrow';
                } else if (daysUntil <= 7) {
                    timeText = `üü¢ In ${daysUntil} days`;
                } else {
                    timeText = `üìÖ ${aptDate.toLocaleDateString()}`;
                }

                const html = `
                    <div class="reminder-item">
                        <div class="reminder-item-title">${apt.doctor_name || 'Appointment'}</div>
                        <div class="reminder-item-detail">üè• ${apt.department || 'General'}</div>
                        <div class="reminder-item-detail">üìç ${apt.location || 'See details'}</div>
                        ${apt.appointment_time ? `<div class="reminder-item-detail">üïê ${apt.appointment_time}</div>` : ''}
                        <div class="reminder-item-time">${timeText}</div>
                    </div>`;

                console.log('Showing appointment:', apt.doctor_name);
                reminderContent.innerHTML = html;
                showReminderBot();

            } catch (error) {
                console.error('Error loading appointment reminder:', error);
            }
        }

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            const userGreeting = document.getElementById('userGreeting');
            const chatBubble = document.getElementById('chatBubbleTrigger');
            const authButton = document.getElementById('authButton');
            
            if (session && session.user) {
                currentUser = session.user;
                isLoggedIn = true;
                const firstName = session.user.user_metadata?.first_name || 
                                 session.user.email.split('@')[0];
                userGreeting.textContent = `Hello, ${firstName}!`;
                userGreeting.onclick = function() {
                    window.location.href = 'profile.html';
                };
                authButton.textContent = 'Sign Out';
                if (chatBubble) chatBubble.classList.add('show');
                authButton.onclick = async function() {
                    await supabase.auth.signOut();
                    window.location.href = 'index.html';
                };
                
                // Load data
                await loadHospitals();
                await loadInsuranceCards();
                await loadAppointments();
                await loadAppointmentReminder();
            } else {
                userGreeting.textContent = '';
                authButton.textContent = 'Sign In';
                authButton.onclick = function() {
                    window.location.href = 'signin.html';
                };
                
                document.querySelector('.container').innerHTML = `
                    <div class="empty-state" style="padding: 100px 20px;">
                        <h3>Please Sign In</h3>
                        <p>You need to be logged in to book appointments.</p>
                        <button onclick="window.location.href='signin.html'" class="btn btn-primary">Sign In</button>
                    </div>
                `;
            }
        }

        function setMinDate() {
            const dateInput = document.getElementById('appointmentDate');
            if (dateInput) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.min = today;
            }
        }

        async function loadHospitals() {
            try {
                const { data, error } = await supabase
                    .from('hospitals')
                    .select('*')
                    .order('hospital_name', { ascending: true });

                if (error) throw error;

                const select = document.getElementById('hospitalSelect');
                select.innerHTML = '<option value="">Select hospital or clinic...</option>';
                
                if (data && data.length > 0) {
                    data.forEach(hospital => {
                        const option = document.createElement('option');
                        option.value = hospital.hospital_id;
                        option.textContent = `${hospital.hospital_name} - ${hospital.city}, ${hospital.state}`;
                        option.dataset.hospital = JSON.stringify(hospital);
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading hospitals:', error);
                showMessage('Error loading hospitals. Please run the appointments_schema.sql file.', 'error');
            }
        }

        async function loadDoctorsForHospital() {
            const select = document.getElementById('hospitalSelect');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption.value) {
                document.getElementById('step2').style.display = 'none';
                document.getElementById('step3').style.display = 'none';
                return;
            }

            selectedHospital = JSON.parse(selectedOption.dataset.hospital);
            document.getElementById('step2').style.display = 'block';

            try {
                const { data, error } = await supabase
                    .from('doctor_hospitals')
                    .select(`
                        doctors (
                            doctor_id,
                            first_name,
                            last_name,
                            specialization,
                            years_of_experience,
                            accepts_new_patients,
                            bio
                        )
                    `)
                    .eq('hospital_id', selectedHospital.hospital_id);

                if (error) throw error;

                allDoctors = data?.map(d => d.doctors).filter(d => d && d.accepts_new_patients) || [];
                
                // Build specializations list
                specializations.clear();
                allDoctors.forEach(doctor => {
                    if (doctor.specialization) {
                        specializations.add(doctor.specialization);
                    }
                });

                // Populate specialization filter
                const specFilter = document.getElementById('specializationFilter');
                specFilter.innerHTML = '<option value="">All Specializations</option>';
                Array.from(specializations).sort().forEach(spec => {
                    const option = document.createElement('option');
                    option.value = spec;
                    option.textContent = spec;
                    specFilter.appendChild(option);
                });

                displayDoctors(allDoctors);

            } catch (error) {
                console.error('Error loading doctors:', error);
                document.getElementById('doctorsList').innerHTML = `
                    <div class="message error">Error loading doctors. They may not have been added yet.</div>
                `;
            }
        }

        function filterDoctors() {
            const filter = document.getElementById('specializationFilter').value;
            if (!filter) {
                displayDoctors(allDoctors);
            } else {
                const filtered = allDoctors.filter(d => d.specialization === filter);
                displayDoctors(filtered);
            }
        }

        function displayDoctors(doctors) {
            const container = document.getElementById('doctorsList');
            
            if (!doctors || doctors.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No doctors available at this location yet.</p>
                    </div>
                `;
                return;
            }

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">';
            doctors.forEach(doctor => {
                html += `
                    <div class="doctor-card" onclick="selectDoctor('${doctor.doctor_id}')">
                        <div class="doctor-name">Dr. ${doctor.first_name} ${doctor.last_name}</div>
                        <div class="doctor-specialty">${doctor.specialization}</div>
                        <div class="doctor-info">
                            ${doctor.years_of_experience ? `${doctor.years_of_experience} years experience` : 'Experienced practitioner'}
                        </div>
                        ${doctor.bio ? `<div class="doctor-info" style="margin-top: 8px; font-size: 12px;">${doctor.bio.substring(0, 100)}...</div>` : ''}
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function selectDoctor(doctorId) {
            selectedDoctor = allDoctors.find(d => d.doctor_id === doctorId);
            
            // Update UI
            document.querySelectorAll('.doctor-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Show step 3
            document.getElementById('step3').style.display = 'block';
            document.getElementById('step3').scrollIntoView({ behavior: 'smooth' });
        }

        async function loadInsuranceCards() {
            try {
                const { data, error } = await supabase
                    .from('insurance_card')
                    .select('*, insurance(provider_name, policy_number)')
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                const select = document.getElementById('insuranceSelect');
                if (data && data.length > 0) {
                    data.forEach(card => {
                        const option = document.createElement('option');
                        option.value = card.card_id;
                        option.textContent = `${card.insurance.provider_name} - ${card.insurance.policy_number}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading insurance:', error);
            }
        }

        // Helper: generate time slots (used as fallback when RPC unavailable)
        function generateTimeSlots(startTime, endTime, durationMinutes) {
            const slots = [];
            if (!startTime || !endTime || !durationMinutes) return slots;

            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);

            let currentMinutes = startHour * 60 + startMin;
            const endMinutes = endHour * 60 + endMin;

            while (currentMinutes + durationMinutes <= endMinutes) {
                const hours = Math.floor(currentMinutes / 60);
                const minutes = currentMinutes % 60;
                const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:00`;
                slots.push(timeString);
                currentMinutes += durationMinutes;
            }

            return slots;
        }

        async function loadAvailableSlots() {
            const date = document.getElementById('appointmentDate').value;

            if (!date || !selectedDoctor || !selectedHospital) {
                return;
            }

            const slotsSection = document.getElementById('timeSlotsSection');
            const slotsList = document.getElementById('timeSlotsList');

            slotsSection.style.display = 'block';
            slotsList.innerHTML = '<div class="loading">Loading available slots...</div>';

            try {
                // First try existing RPC (fast, DB-side logic)
                const { data, error } = await supabase
                    .rpc('get_available_slots', {
                        p_doctor_id: selectedDoctor.doctor_id,
                        p_hospital_id: selectedHospital.hospital_id,
                        p_date: date
                    });

                if (!error && data && data.length > 0) {
                    let html = '';
                    data.forEach(slot => {
                        const available = slot.is_available;
                        html += `
                            <div class="time-slot ${!available ? 'unavailable' : ''}"
                                onclick="${available ? `selectTimeSlot('${slot.slot_time}', event)` : 'return false;'}">
                                ${formatTime(slot.slot_time)}
                            </div>
                        `;
                    });
                    slotsList.innerHTML = html;
                    return;
                }

                // Fallback: use doctor_availability table and generate time slots on client
                const selectedDate = date;
                const dayOfWeek = new Date(selectedDate).getDay();

                const { data: availability, error: availError } = await supabase
                    .from('doctor_availability')
                    .select('*')
                    .eq('doctor_id', selectedDoctor.doctor_id)
                    .eq('hospital_id', selectedHospital.hospital_id)
                    .eq('day_of_week', dayOfWeek)
                    .eq('is_active', true)
                    .single();

                if (availError || !availability) {
                    slotsList.innerHTML = `
                        <div class="empty-state">
                            <p>No available slots for this date. Please select another date.</p>
                        </div>
                    `;
                    return;
                }

                const slots = generateTimeSlots(
                    availability.start_time,
                    availability.end_time,
                    availability.slot_duration_minutes
                );

                // Get already booked appointments for this doctor on this date
                const { data: bookedAppointments, error: bookError } = await supabase
                    .from('appointments')
                    .select('appointment_time')
                    .eq('doctor_id', selectedDoctor.doctor_id)
                    .eq('hospital_id', selectedHospital.hospital_id)
                    .eq('appointment_date', selectedDate)
                    .in('status', ['pending', 'confirmed']);

                if (bookError) throw bookError;

                const bookedTimes = bookedAppointments?.map(apt => apt.appointment_time) || [];
                const availableSlots = slots.filter(slot => !bookedTimes.includes(slot));

                if (!availableSlots || availableSlots.length === 0) {
                    slotsList.innerHTML = `
                        <div class="empty-state">
                            <p>No available slots for this date. Please select another date.</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                availableSlots.forEach(slot => {
                    html += `
                        <div class="time-slot" onclick="selectTimeSlot('${slot}', event)">
                            ${formatTime(slot)}
                        </div>
                    `;
                });

                slotsList.innerHTML = html;

            } catch (error) {
                console.error('Error loading slots:', error);
                slotsList.innerHTML = `
                    <div class="message error">Unable to load time slots. The doctor may not have availability set for this day.</div>
                `;
            }
        }

        function selectTimeSlot(time, event) {
            selectedTimeSlot = time;

            document.querySelectorAll('.time-slot, .time-slot-btn').forEach(slot => {
                slot.classList.remove('selected');
            });
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('selected');
            }
        }

        function formatTime(timeString) {
            const time = timeString.substring(0, 5);
            const [hours, minutes] = time.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        async function bookAppointment(event) {
            event.preventDefault();

            if (!selectedDoctor) {
                showMessage('Please select a doctor', 'error');
                return;
            }

            if (!selectedTimeSlot) {
                showMessage('Please select a time slot', 'error');
                return;
            }

            const appointmentType = document.getElementById('appointmentType').value;
            const firstVisit = document.getElementById('firstVisit').value === 'true';
            const visitReason = document.getElementById('visitReason').value;
            const symptoms = document.getElementById('symptoms').value;
            const appointmentDate = document.getElementById('appointmentDate').value;
            const insuranceCardId = document.getElementById('insuranceSelect').value || null;
            const patientNotes = document.getElementById('patientNotes').value;

            try {
                // Check for existing active appointments at the same time slot
                const { data: existingAppointments, error: checkError } = await supabase
                    .from('appointments')
                    .select('appointment_id, status')
                    .eq('doctor_id', selectedDoctor.doctor_id)
                    .eq('appointment_date', appointmentDate)
                    .eq('appointment_time', selectedTimeSlot)
                    .in('status', ['pending', 'confirmed']);

                if (checkError) throw checkError;

                if (existingAppointments && existingAppointments.length > 0) {
                    showMessage('This time slot is no longer available. Please select another time.', 'error');
                    // Reload slots to show current availability
                    await loadAvailableSlots();
                    return;
                }

                // Proceed with booking
                const { error } = await supabase
                    .from('appointments')
                    .insert([{
                        user_id: currentUser.id,
                        doctor_id: selectedDoctor.doctor_id,
                        hospital_id: selectedHospital.hospital_id,
                        appointment_date: appointmentDate,
                        appointment_time: selectedTimeSlot,
                        appointment_type: appointmentType,
                        visit_reason: visitReason,
                        symptoms: symptoms || null,
                        is_first_visit: firstVisit,
                        insurance_card_id: insuranceCardId,
                        patient_notes: patientNotes || null,
                        status: 'pending'
                    }]);

                if (error) {
                    console.error('Database error:', error);

                    // Provide user-friendly error messages for common constraint violations
                    if (error.code === '23505') { // Unique constraint violation
                        if (error.message.includes('appointments_user_doctor_date_time')) {
                            showMessage('You already have an appointment with this doctor at this time. Please choose a different time slot.', 'error');
                        } else if (error.message.includes('appointments_doctor_date_time')) {
                            showMessage('This time slot has just been booked. Please select another time.', 'error');
                            await loadAvailableSlots();
                        } else {
                            showMessage('This appointment conflicts with an existing booking. Please select a different time or doctor.', 'error');
                        }
                    } else {
                        showMessage('Error booking appointment: ' + error.message, 'error');
                    }
                    return;
                }

                showMessage('Appointment booked successfully! Waiting for doctor confirmation.', 'success');

                setTimeout(() => {
                    resetForm();
                    loadAppointments();
                }, 2000);

            } catch (error) {
                console.error('Error booking appointment:', error);
                showMessage('Error booking appointment: ' + error.message, 'error');
            }
        }

        function resetForm() {
            document.getElementById('appointmentForm').reset();
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step3').style.display = 'none';
            selectedHospital = null;
            selectedDoctor = null;
            selectedTimeSlot = null;
            document.querySelectorAll('.doctor-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            showMessage('', '');
        }

        async function loadAppointments() {
            try {
                const { data, error } = await supabase
                    .from('appointments')
                    .select(`
                        *,
                        doctors (first_name, last_name, specialization),
                        hospitals (hospital_name, city, state)
                    `)
                    .eq('user_id', currentUser.id)
                    .order('appointment_date', { ascending: false })
                    .order('appointment_time', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('appointmentsList');
                
                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No Appointments Yet</h3>
                            <p>Book your first appointment above</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                data.forEach(appt => {
                    const date = new Date(appt.appointment_date).toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    const time = formatTime(appt.appointment_time);
                    const statusClass = `badge-${appt.status}`;

                    html += `
                        <div class="appointment-item">
                            <div class="appointment-header">
                                <div>
                                    <div class="appointment-title">${appt.appointment_type}</div>
                                    <div style="color: #5b21b6; font-weight: 600; margin-top: 5px;">
                                        Dr. ${appt.doctors.first_name} ${appt.doctors.last_name}
                                    </div>
                                </div>
                                <span class="badge ${statusClass}">${appt.status.toUpperCase()}</span>
                            </div>
                            
                            <div class="appointment-details">
                                <div class="detail-item">
                                    <span class="detail-label">Date & Time</span>
                                    <span class="detail-value">${date}<br>${time}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Location</span>
                                    <span class="detail-value">${appt.hospitals.hospital_name}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Specialization</span>
                                    <span class="detail-value">${appt.doctors.specialization}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Visit Reason</span>
                                    <span class="detail-value">${appt.visit_reason.substring(0, 50)}${appt.visit_reason.length > 50 ? '...' : ''}</span>
                                </div>
                            </div>

                            ${appt.status === 'pending' || appt.status === 'confirmed' ? `
                                <div style="margin-top: 15px;">
                                    <button onclick="cancelAppointment('${appt.appointment_id}')" class="btn btn-danger btn-small">
                                        Cancel Appointment
                                    </button>
                                </div>
                            ` : ''}

                            ${appt.status === 'completed' || appt.status === 'cancelled' ? `
                                <div style="margin-top: 15px;">
                                    <button onclick="deleteAppointment('${appt.appointment_id}')" class="btn btn-danger btn-small">
                                        Delete Appointment
                                    </button>
                                </div>
                            ` : ''}

                            ${appt.doctor_notes ? `
                                <div style="margin-top: 15px; padding: 12px; background: #f8fafc; border-radius: 6px;">
                                    <strong style="color: #5b21b6;">Doctor's Notes:</strong><br>
                                    ${appt.doctor_notes}
                                </div>
                            ` : ''}
                        </div>
                    `;
        
            initializeChat();
        });

                container.innerHTML = html;

            } catch (error) {
                console.error('Error loading appointments:', error);
                document.getElementById('appointmentsList').innerHTML = `
                    <div class="message error">Error loading appointments</div>
                `;
            }
        }

        async function cancelAppointment(appointmentId) {
            if (!confirm('Are you sure you want to cancel this appointment?')) {
                return;
            }

            const reason = prompt('Please provide a reason for cancellation (optional):');

            try {
                const { error } = await supabase
                    .from('appointments')
                    .update({
                        status: 'cancelled',
                        cancellation_reason: reason || 'Patient cancelled'
                    })
                    .eq('appointment_id', appointmentId);

                if (error) {
                    console.error('Cancel error details:', error);
                    throw error;
                }

                alert('Appointment cancelled successfully');
                loadAppointments();

            } catch (error) {
                console.error('Error cancelling appointment:', error);
                alert('Error cancelling appointment: ' + (error.message || 'Unknown error'));
            }
        }

        async function deleteAppointment(appointmentId) {
            if (!confirm('Are you sure you want to permanently delete this appointment? This cannot be undone.')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('appointments')
                    .delete()
                    .eq('appointment_id', appointmentId);

                if (error) throw error;

                alert('Appointment deleted successfully');
                loadAppointments();

            } catch (error) {
                console.error('Error deleting appointment:', error);
                alert('Error deleting appointment: ' + error.message);
            }
        }

        function showMessage(message, type) {
            const container = document.getElementById('bookingMessage');
            if (!message) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
    </script>
    <script>
        async function loadAvailableDoctors() {
            try {
                // Get all doctors who have active availability
                const { data: availableDoctors, error } = await supabase
                    .from('doctor_availability')
                    .select(`
                        doctor_id,
                        doctors (
                            doctor_id,
                            first_name,
                            last_name,
                            specialization
                        )
                    `)
                    .eq('is_active', true);

                if (error) throw error;

                // Remove duplicates (same doctor might have multiple availability records)
                const uniqueDoctors = {};
                availableDoctors?.forEach(item => {
                    if (item.doctors) {
                        uniqueDoctors[item.doctors.doctor_id] = item.doctors;
                    }
                });

                // Populate doctor dropdown
                const doctorSelect = document.getElementById('doctorSelect');
                if (!doctorSelect) return; // element not present in current layout
                Object.values(uniqueDoctors).forEach(doctor => {
                    const option = document.createElement('option');
                    option.value = doctor.doctor_id;
                    option.textContent = `Dr. ${doctor.first_name} ${doctor.last_name} - ${doctor.specialization}`;
                    doctorSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading doctors:', error);
            }
        }

        async function loadDoctorHospitals(doctorId) {
            try {
                const { data, error } = await supabase
                    .from('doctor_hospitals')
                    .select(`
                        hospital_id,
                        hospitals (
                            hospital_id,
                            hospital_name,
                            address,
                            city,
                            state
                        )
                    `)
                    .eq('doctor_id', doctorId);

                if (error) throw error;

                const hospitalSelect = document.getElementById('hospitalSelect');
                if (!hospitalSelect) return;
                hospitalSelect.innerHTML = '<option value="">Select a hospital...</option>';
                
                data?.forEach(item => {
                    if (item.hospitals) {
                        const option = document.createElement('option');
                        option.value = item.hospitals.hospital_id;
                        option.textContent = `${item.hospitals.hospital_name} - ${item.hospitals.city}, ${item.hospitals.state}`;
                        hospitalSelect.appendChild(option);
                    }
                });

                hospitalSelect.disabled = false;
            } catch (error) {
                console.error('Error loading hospitals:', error);
            }
        }

        async function loadAvailableTimeSlots(doctorId, hospitalId, selectedDate) {
            try {
                // Get day of week for the selected date (0 = Sunday, 6 = Saturday)
                const date = new Date(selectedDate);
                const dayOfWeek = date.getDay();

                // Get doctor's availability for this day and hospital
                const { data: availability, error: availError } = await supabase
                    .from('doctor_availability')
                    .select('*')
                    .eq('doctor_id', doctorId)
                    .eq('hospital_id', hospitalId)
                    .eq('day_of_week', dayOfWeek)
                    .eq('is_active', true)
                    .single();

                if (availError || !availability) {
                    const container = document.getElementById('timeSlotContainer');
                    if (container) container.innerHTML = 
                        '<p>Doctor is not available on this day at this location.</p>';
                    return;
                }

                // Generate all possible time slots
                const slots = generateTimeSlots(
                    availability.start_time,
                    availability.end_time,
                    availability.slot_duration_minutes
                );

                // Get already booked appointments for this doctor on this date
                const { data: bookedAppointments, error: bookError } = await supabase
                    .from('appointments')
                    .select('appointment_time')
                    .eq('doctor_id', doctorId)
                    .eq('hospital_id', hospitalId)
                    .eq('appointment_date', selectedDate)
                    .in('status', ['pending', 'confirmed']);

                if (bookError) throw bookError;

                // Filter out booked slots
                const bookedTimes = bookedAppointments?.map(apt => apt.appointment_time) || [];
                const availableSlots = slots.filter(slot => !bookedTimes.includes(slot));

                // Display available slots
                displayTimeSlots(availableSlots);

            } catch (error) {
                console.error('Error loading time slots:', error);
            }
        }

        function generateTimeSlots(startTime, endTime, durationMinutes) {
            const slots = [];
            
            // Convert time strings to minutes since midnight
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);
            
            let currentMinutes = startHour * 60 + startMin;
            const endMinutes = endHour * 60 + endMin;
            
            while (currentMinutes + durationMinutes <= endMinutes) {
                const hours = Math.floor(currentMinutes / 60);
                const minutes = currentMinutes % 60;
                const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:00`;
                slots.push(timeString);
                currentMinutes += durationMinutes;
            }
            
            return slots;
        }

        function displayTimeSlots(slots) {
            const container = document.getElementById('timeSlotContainer');
            if (!container) return;
            
            if (slots.length === 0) {
                container.innerHTML = '<p>No available time slots for this date.</p>';
                return;
            }
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;">';
            
            slots.forEach(slot => {
                // Format time for display (convert 24hr to 12hr)
                const [hours, minutes] = slot.split(':');
                const hour = parseInt(hours);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour % 12 || 12;
                const displayTime = `${displayHour}:${minutes} ${ampm}`;
                
                html += `
                    <button class="time-slot-btn" onclick="selectTimeSlotExample('${slot}', event)">
                        ${displayTime}
                    </button>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        let selectedTimeSlotExample = null;

        function selectTimeSlotExample(time, event) {
            // This is for the example booking section
            selectedTimeSlotExample = time;

            // Highlight selected button
            document.querySelectorAll('.time-slot-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('selected');
            } else {
                // Fallback: find the button and add selected class
                const btn = Array.from(document.querySelectorAll('.time-slot-btn')).find(b => b.getAttribute('onclick')?.includes(time));
                if (btn) btn.classList.add('selected');
            }
        }

        async function bookAppointmentExample() {
            const doctorId = document.getElementById('doctorSelect')?.value;
            const hospitalId = document.getElementById('hospitalSelect')?.value;
            const appointmentDate = document.getElementById('dateSelect')?.value;
            const appointmentType = document.getElementById('appointmentType')?.value;
            const visitReason = document.getElementById('visitReason')?.value;
            const symptoms = document.getElementById('symptoms')?.value;
            const patientNotes = document.getElementById('patientNotes')?.value;

            if (!doctorId || !hospitalId || !appointmentDate || !selectedTimeSlotExample || !appointmentType || !visitReason) {
                alert('Please fill in all required fields and select a time slot');
                return;
            }

            try {
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    alert('Please sign in to book an appointment');
                    return;
                }

                const { data, error } = await supabase
                    .from('appointments')
                    .insert([{ 
                        user_id: user.id,
                        doctor_id: doctorId,
                        hospital_id: hospitalId,
                        appointment_date: appointmentDate,
                        appointment_time: selectedTimeSlotExample,
                        appointment_type: appointmentType,
                        visit_reason: visitReason,
                        symptoms: symptoms,
                        patient_notes: patientNotes,
                        status: 'pending',
                        is_first_visit: false // You can add a checkbox for this
                    }]);

                if (error) throw error;

                alert('Appointment booked successfully! The doctor will confirm your appointment soon.');
                
                // Redirect or reset form
                window.location.href = 'appointments.html';

            } catch (error) {
                console.error('Error booking appointment:', error);
                alert('Error booking appointment: ' + (error.message || error));
            }
        }
        window.addEventListener('DOMContentLoaded', () => {
            const doctorSelect = document.getElementById('doctorSelect');
            if (doctorSelect) loadAvailableDoctors();
        });
    </script>
</body>
</html>